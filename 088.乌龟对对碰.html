<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/global.css">

    <style>
        .turtle-blind-box {
            position: relative;
            display: flex;
            width: 400px;
            height: 400px;
        }

        .turtle-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            display: grid;
            border-left: 2px solid #666;
            border-top: 2px solid #666;
            grid-template-columns: repeat(3, calc(100% / 3));
            grid-template-rows: repeat(3, calc(100% / 3));
        }

        .turtle-grid-item {
            border-right: 2px solid #666;
            border-bottom: 2px solid #666;
            counter-increment: item-counter;
            position: relative;
        }

        .turtle-grid-item img {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .turtle-grid-item::after {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: #000;
            font-size: 40px;
            content: counter(item-counter);
        }
    </style>
</head>

<body>
    <!-- 
        规则    

        共有10种颜色的乌龟，出现概率均等（各占总数的1/10），每次完全随机抽取，“买家”可以“许愿”一种幸运颜色，初始指定乌龟总数，依次放入1-9号格，放满后开始结算。
        触发幸运色：每拆出1只幸运色乌龟，立刻加赠1只；
        对对碰：2个同色格，一起拿走，加赠1只； ✔
        三连位：同一直线上（横、竖、对角线）3个同色格，一起拿走，加赠5只； ✔
        全不同：9个格子颜色全不同，一起拿走，加赠10只。 
        清台: +5
    -->

    <div class="turtle-blind-box">
        <div class="turtle-grid">
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
            <div class="turtle-grid-item"></div>
        </div>

        <!-- 开始面板 -->
        <div class="start-panel">
            <!-- 选择颜色 -->

            <!-- 许愿色  -->

            <!-- 选择数量 -->

            <!-- 10包  30包  50包 -->

            <!-- 开始 -->
        </div>

    </div>



    <script type="module">

        import { Randoms } from "https://gcore.jsdelivr.net/npm/@3r/tool/lib/randoms.js";


        /**
         * 初始化平面数组
         * @author 	 linyisonger
         * @date 	 2025-01-13
         * 
         * @template T
         * @param {number} rows
         * @param {number} cols
         * @param {T|(x,y)=>T} init 
         * 
         * @return {T[][]}
         */
        function createFlatArray(rows, cols, init = 0) {
            let level1 = []
            for (let y = 0; y < cols; y++) {
                let level2 = [];
                for (let x = 0; x < rows; x++) {
                    level2[x] = typeof init == "function" ? init(x, y) : init;
                }
                level1[y] = level2
            }
            return level1
        }

        // 红色、黄色、紫色、橙色、绿色、青色、粉色、蓝色、咖色和玫红色‌
        const TURTLE_COLOR = {
            NONE: '',
            RED: 'red',
            YELLOW: 'yellow',
            PURPLE: 'purple',
            ORANGE: 'orange',
            GREEN: 'green',
            CYAN: 'cyan',
            PINK: 'pink',
            BLUE: 'blue',
            BROWN: 'brown',
            ROSE: "rose"
        }

        class Turtle {
            x = 0;
            y = 0;
            color = TURTLE_COLOR.NONE;
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }

        const assetConfig = {
            'red': './assets/turtle/red.png',
            'yellow': './assets/turtle/yellow.png',
            'purple': './assets/turtle/purple.png',
            'orange': './assets/turtle/orange.png',
            'green': './assets/turtle/green.png',
            'cyan': './assets/turtle/cyan.png',
            'pink': './assets/turtle/pink.png',
            'blue': './assets/turtle/blue.png',
            'brown': './assets/turtle/brown.png',
            "rose": './assets/turtle/rose.png',
        }


        let map = createFlatArray(3, 3, (x, y) => new Turtle(x, y)) // 地图
        let colors = Object.keys(assetConfig) // 颜色
        let turtles = map.flat(2) // 所有乌龟
        let turtlesDom = document.querySelectorAll('.turtle-grid-item') // 九宫格
        let luckyColor = colors[1]; // 幸运色
        let buyCount = 20;  // 购买数量
        let unpackCount = 0; // 拆开数量
        /**
         * 相同的
         * @author 	 linyisonger
         * @date 	 2025-01-16
         */
        function same(self, target) {
            return map[self.y][self.x].color == map[target.y][target.x].color
        }

        /**
         * 二连判断
         * @author 	 linyisonger
         * @date 	 2025-01-16
         */
        function isTwin() {
            let sameList = []
            // 横向
            for (let x = 0; x < 2; x++) {
                for (let y = 0; y < 3; y++) {
                    let sameArray = isSameMatch({ x, y }, { x: 1, y: 0 }, 1)
                    sameArray.length && sameList.push(sameArray)
                }
            }
            // 纵向
            for (let y = 0; y < 2; y++) {
                for (let x = 0; x < 3; x++) {
                    let sameArray = isSameMatch({ x, y }, { x: 0, y: 1 }, 1)
                    sameArray.length && sameList.push(sameArray)
                }
            }
            return sameList;
        }

        /**
         * 三连判断
         * @author 	 linyisonger
         * @date 	 2025-01-16
         */
        function isTriplet() {
            let sameList = []
            // 横向
            for (let i = 0; i < 3; i++) {
                let sameArray = isSameMatch({ x: 0, y: i }, { x: 1, y: 0 })
                sameArray.length && sameList.push(sameArray)
            }
            // 纵向
            for (let i = 0; i < 3; i++) {
                let sameArray = isSameMatch({ x: i, y: 0 }, { x: 0, y: 1 })
                sameArray.length && sameList.push(sameArray)
            }
            // 对角线 - 左上 右下
            {
                let sameArray = isSameMatch({ x: 0, y: 0 }, { x: 1, y: 1 })
                sameArray.length && sameList.push(sameArray)
            }
            // 对角线 - 右上 左下
            {
                let sameArray = isSameMatch({ x: 2, y: 0 }, { x: -1, y: 1 })
                sameArray.length && sameList.push(sameArray)
            }
            return sameList;
        }

        /**
         * 是否相同位置匹配
         * @author 	 linyisonger
         * @date 	 2025-01-16
         */
        function isSameMatch(start, direction, count = 2) {
            let sameArray = [start]
            for (let i = 0; i < count; i++) {
                let last = sameArray[sameArray.length - 1]
                let target = { x: last.x + direction.x, y: last.y + direction.y }
                if (!same(last, target)) return []
                sameArray.push(target)
            }
            return sameArray;
        }


        /**
         * 拆盲盒
         * @author 	 linyisonger
         * @date 	 2025-01-16
         */
        function unpack() {
            // 颜色
            let color = colors[Randoms.int(0, colors.length)]
            // 幸运色

            // 第一
            let turtleIndex = turtles.findIndex(t => t.color == TURTLE_COLOR.NONE);
            // 结束
            if (buyCount == unpackCount) {
                
            }
            // 摆放
            else if (turtleIndex > -1) {
                turtles[turtleIndex].color = color;
                // 新建IMG
                let imgDom = document.createElement('img')
                imgDom.src = assetConfig[color]
                turtlesDom.item(turtleIndex).appendChild(imgDom)
                unpackCount++;
                unpack();

            }
            // 结算
            else {
                // 九不同

                // 三连
                isTriplet();
                // 二连
                isTwin();
                // 清台
            }
        }


        unpack()


        console.log(isTwin());

    </script>


</body>

</html>