<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/global.css">


    <style>
        body {
            height: 100vh;
        }

        .flex-row-center {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .flex-column-center {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }


        .game-container {
            position: relative;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            user-select: none;
        }

        .map-container {
            position: absolute;
            left: 0;
            top: 0;
            background-size: contain;
        }





        .role-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            width: 600px;
            height: 415px;
        }

        .role-container .role-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .role-container .role-body {
            margin: 0 20px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        .role-container .role-item-container {
            display: flex;
            width: 100%;
            justify-content: space-between;
        }

        .role-container .role-item {
            display: flex;
            flex: 1;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            margin: 20px 10px;
        }

        .role-container .role-item.active {
            background-color: #2776ec2f;
        }

        .role-container .role-item-name {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }

        .role-container .role-item-avatar {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            background-size: contain;
        }

        .role-container .target-item-container {
            display: flex;
            width: 100%;
            padding-bottom: 20px;
        }

        .role-container .target-item {
            display: flex;
            flex-direction: column;
            flex: 1;
            align-items: center;
        }

        .role-container .target-item input {
            width: 70px;
            outline: none;
            border-top: 0;
            border-left: 0;
            border-right: 0;
            border-width: 1px;
            border-color: #2e2e2e;
            background-color: transparent;
            margin-left: 5px;
            text-align: center;
        }

        .role-container .target-item.error input {
            border-color: #cc0000;
        }

        .role-container .target-item.valid input {
            border-color: #00cc00;
        }


        .role-container .target-item-content {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .role-container .target-hint {
            width: 100%;
            font-size: 14px;
            margin-bottom: 20px;
            margin-left: 20px;
        }

        .role-container.close {
            top: -100%;
        }





        .game-btn-confirm {
            display: inline-flex;
            padding: 0 20px;
            line-height: 40px;
            background-color: #2776ec;
            color: #fff;
            cursor: pointer;
        }




        .game-btn-confirm:active {
            opacity: .7;
        }

        object {
            pointer-events: none;
        }

        .map-container.anim {
            transition: all .2s linear;
        }

        .map-container .station-item {
            position: absolute;
            border: 2px solid #00cc00;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .map-container .player-item {
            display: inline-flex;
        }

        .map-container .player-avatar {
            margin: 10px;
            width: 60px;
            height: 60px;
            background-size: contain;
            border-radius: 50%;
        }

        .map-container .player-item.active .player-avatar {
            border-width: 5px;
            border-style: solid;
        }



        .dialog-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            width: 500px;
        }

        .dialog-container.close {
            top: -100%;
        }


        .dialog-container .dialog-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            margin: 0 20px;
        }

        .dialog-container .dialog-body {
            padding-top: 20px;
            margin: 0 20px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        .dialog-container .dialog-body-option {
            margin-top: 10px;
            display: flex;
            padding: 0 20px;
            align-items: center;
            height: 40px;
            background-color: #2776ec;
            color: #fff;
            cursor: pointer;
            justify-content: center;
        }

        .dialog-container .dialog-body-option:nth-child(2) {
            background-color: #a1a1a1;
        }

        .dialog-container .dialog-body-content img {
            width: 100%;
        }

        .hospital-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            width: 500px;
            padding-left: 40px;
            padding-right: 40px;
            padding-top: 30px;
        }

        .hospital-container .logo {
            position: absolute;
            top: 0;
            left: 20px;
            transform: translate(0, -70%);
        }

        .hospital-container .logo img {
            width: 150px;
        }

        .hospital-container .hospital-message {
            margin-top: 20px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .hospital-container .hospital-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .hospital-container .hospital-item img {
            height: 20px
        }

        .hospital-container .hospital-item img:last-child {
            margin-right: 10px;
        }

        .hospital-container .hospital-item:last-child {
            color: #a1a1a1;
            font-size: 14px;
        }

        .hospital-container .hospital-footer {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }


        .hospital-container.close {
            top: -100%;
        }



        .park-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            width: 500px;
            padding-left: 40px;
            padding-right: 40px;
            padding-top: 30px;
        }

        .park-container .logo {
            position: absolute;
            top: 0;
            left: 20px;
            transform: translate(0, -60%);
        }

        .park-container .logo img {
            width: 150px;
        }

        .park-container .park-message {
            margin-top: 20px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .park-container .park-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .park-container .park-item img {
            height: 30px
        }

        .park-container .park-item img:last-child {
            margin-right: 10px;
        }

        .park-container .park-footer {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }


        .park-container.close {
            top: -100%;
        }


        .lottery-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            width: 600px;
            padding-left: 40px;
            padding-right: 40px;
            padding-top: 30px;
            padding-bottom: 20px;
            transition: top .5s linear;
        }

        .lottery-container .logo {
            position: absolute;
            top: 0;
            left: 20px;
            transform: translate(0, -70%);
        }

        .lottery-container .logo img {
            width: 150px;
        }

        .lottery-container .lottery-message {
            margin-top: 20px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .lottery-container .lottery-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .lottery-container .lottery-item img {
            height: 30px
        }

        .lottery-container .lottery-item img:last-child {
            margin-right: 10px;
        }

        .lottery-container .lottery-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .lottery-container .player-item {
            display: flex;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }

        .lottery-container .player-item .player-avatar {
            width: 40px;
            height: 40px;
            background-size: contain;
            border-radius: 50%;
            margin-right: 20px;
        }


        .lottery-container .player-operate {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .lottery-container .operate-item .game-btn-confirm:last-child {
            background-color: #a1a1a1;
            margin-left: 10px;
        }

        .lottery-container .operate-item {
            display: flex;
            align-items: center;
        }

        .lottery-container .operate-dice {
            margin-right: 20px;
            display: flex;
            align-items: center;
        }

        .lottery-container.close {
            top: -100%;
        }
    </style>
</head>

<body>
    <template id="log-template">
        <div class="log-header">
            <div class="log-header-title">
                游戏日志
            </div>
            <div class="log-icon-close">
                <img src="./assets/monopoly-life/arrow.png" />
            </div>
        </div>
        <div class="log-body"></div>
        <style>
            :host {
                position: absolute;
                left: 0;
                bottom: 0;
                height: 50%;
                width: 500px;
                background-color: rgba(255, 255, 255, .7);
                border-radius: 20px 20px 0 0;
            }

            :host(.close) {
                bottom: calc(-50% + 50px);
            }

            :host(.close) .log-icon-close {
                transform: rotate(180deg);
            }

            .log-header-title {
                line-height: 50px;
                font-size: 20px;
                font-weight: bold;
                text-align: center;
            }

            .log-body {
                margin: 0 20px 20px;
                height: calc(100% - 70px);
                overflow-y: auto;
            }

            .log-icon-close {
                position: absolute;
                top: 15px;
                right: 20px;
            }

            .log-item-table {
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                border-collapse: collapse;
            }

            .log-item-table td {
                border-right: 1px solid #000;
                border-bottom: 1px solid #000;
                text-align: center;
            }
        </style>
    </template>
    <template id="players-template">
        <style>
            :host {
                display: flex;
                position: absolute;
                top: 0px;
                right: 0;
                background-color: rgba(255, 255, 255, .9);
            }

            :host(.close) {
                transform: 0;
            }

            .player-item {
                display: flex;
                padding: 10px 10px 10px 20px;
                width: 228px;
                height: 120px;
                align-items: center;
                box-sizing: border-box;
                position: relative;
            }

            .player-item.active .player-avatar::after {
                position: absolute;
                background-image: url('./assets/monopoly-life/dice.png');
                background-size: 20px 20px;
                background-repeat: no-repeat;
                width: 20px;
                height: 20px;
                right: 0;
                bottom: 0;
                content: "";
            }

            .player-item:hover .player-more {
                display: block;
            }

            .player-more {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: rgba(255, 255, 255, .9);
            }

            .player-target-container,
            .player-exp-container {
                display: flex;
                flex-direction: column;
                padding: 5px 10px 0;
            }

            .player-target-body,
            .player-exp-body {
                display: flex;
                padding: 5px 0px 0;
            }

            .player-exp-body {
                padding-bottom: 5px;
            }

            .player-target-item {
                display: flex;
                flex: 1;
                justify-content: center;
            }

            .player-avatar {
                margin: 10px;
                width: 60px;
                height: 60px;
                background-size: contain;
                border-radius: 50%;
                position: relative;
            }




            .player-base-info {
                display: flex;
                flex-direction: column;
            }

            .player-base-info>div {
                display: flex;
            }

            .player-icon {
                margin-right: 10px;
            }
        </style>
    </template>
    <template id="dice-template">
        <div class="dice-header">
            <div class="dice-header-title">
                掷骰子
            </div>
        </div>
        <div class="dice-body">
            <div class="dice-item-container">
                <div class="dice-item"></div>
                <div class="dice-item"></div>
            </div>
            <div class="game-btn-confirm">开始转动</div>
        </div>
        <style>
            :host {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 500px;
                background-color: rgba(255, 255, 255, .9);
                border-radius: 20px;
            }

            :host(.close) {
                top: -100%;
            }

            .dice-header-title {
                line-height: 50px;
                font-size: 20px;
                font-weight: bold;
                text-align: center;
            }

            .dice-body {
                margin: 0 20px 20px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .dice-item {
                width: 50px;
                height: 50px;
                background-repeat: no-repeat;
                background-size: 100%;
                margin-bottom: 20px;
            }

            .dice-item:nth-child(n+2) {
                margin-left: 20px;
            }

            .dice-item-container {
                display: flex;
            }



            .dice-item.hidden {
                display: none;
            }
        </style>
    </template>




    <script type="module">

        import { Maths } from "https://gcore.jsdelivr.net/npm/@3r/tool/lib/maths.js";
        import { Randoms } from "https://gcore.jsdelivr.net/npm/@3r/tool/lib/randoms.js";
        /** 获取数字
         * @param {string} str 
         */
        function getNumber(str) {
            return +str.match(/[-\d]{0,}/)[0]
        }

        /** 加载图
         * @param {string} src
         * @returns {Promise<HTMLImageElement>}
         */
        function loadImage(src) {
            return new Promise((resolve) => {
                let image = new Image()
                image.src = src;
                image.onload = (ev) => {
                    resolve(image)
                }
            })
        }

        /** 拖拽元素
         * @param {HTMLImageElement} dom
         * @param {{minX:number,maxX:number,minY:number,maxY:number}} options
         */
        function dragging(dom, options) {
            // 开始坐标位置
            let startX = 0;
            let startY = 0;
            let startLeft = 0;
            let startTop = 0;
            let isMove = false;

            dom.classList.add('anim')

            dom.addEventListener("mousedown", ev => {
                // 移除动画标签
                dom.classList.remove('anim')

                startX = ev.x;
                startY = ev.y;
                startLeft = getNumber(dom.style.left);
                startTop = getNumber(dom.style.top);
                isMove = true;
            })

            dom.addEventListener("mousemove", ev => {
                if (!isMove) return;
                let left = startLeft + ev.x - startX;
                let top = startTop + ev.y - startY;
                left = Maths.inRange(left, options.minX, options.maxX)
                top = Maths.inRange(top, options.minY, options.maxY)
                dom.style.left = left + 'px';
                dom.style.top = top + 'px';
            })

            dom.addEventListener("mouseup", ev => {
                // 增加动画标签
                dom.classList.add('anim')
                isMove = false;
            })

            let screenWidth = document.body.clientWidth
            let screenHeight = document.body.clientHeight

            /**
             * @param {HTMLDivElement} target
             */
            const lookAt = async function (target) {
                let left = - (target.offsetLeft + target.offsetWidth / 2 - screenWidth / 2)
                let top = - (target.offsetTop + target.offsetHeight / 2 - screenHeight / 2)
                left = Maths.inRange(left, options.minX, options.maxX)
                top = Maths.inRange(top, options.minY, options.maxY)
                dom.style.left = left + 'px';
                dom.style.top = top + 'px';
            }

            return {
                lookAt
            }
        }

        /** 等待多久 
         */
        function wait(ms) {
            return new Promise((resolve) => {
                setTimeout(resolve, ms)
            })
        }

        /** 创建容器
         * @param {string} html 
         */
        function createFragment(html) {
            const fragment = document.createDocumentFragment();
            const div = document.createElement("div");
            div.innerHTML = html;
            fragment.appendChild(div.children.item(0))
            return fragment;
        }

        /** 模板加载
         * @param {string} selectors 
         */
        function templateLoad(selectors) {
            let template = document.querySelector(selectors)
            let clone = document.importNode(template.content, true);
            let container = document.createElement('div')
            container.id = Randoms.uuid();
            let shadowRoot = container.attachShadow({ mode: "open" });
            shadowRoot.appendChild(clone)
            // 仅输出宿主节点
            // 影子节点可以通过 container.shadowRoot.querySelector 进行查询
            return container
        }

        /** 玩家行动美剧 */
        const PlayerActionEnum = {
            /** 默认 */
            NONE: 0,
            /** 再次 */
            AGAIN: 1,
            /** 暂停 */
            PAUSE: -1
        }

        /** 位置类型枚举 */
        const PositionTypeEnum = {
            /** 环道 */
            LOOP: 1,
            /** 农业 */
            AGRICULTURE: 2,
            /** 大学 */
            UNIVERSITY: 3,
            /** 企业 */
            ENTERPRISE: 4,
            /** 航行 */
            VOYAGE: 5,
            /** 公益 */
            WELFARE: 6,
            /** 影视 */
            MOVIES: 7,
            /** 采矿 */
            MINING: 8,
            /** 太空 */
            SPACE: 9
        }

        /** 图片配置 */
        const ICON_CONFIG = {
            RICHES: `<img src="./assets/monopoly-life/riches.png" />`,
            SALARY: `<img src="./assets/monopoly-life/salary.png" />`,
            REPUTE: `<img src="./assets/monopoly-life/repute.png" />`,
            HAPPY: `<img src="./assets/monopoly-life/happy.png" /> `,
            ARROW: `<img src="./assets/monopoly-life/arrow.png" />`,
            AGRICULTURE: `<img src="./assets/monopoly-life/agriculture.png"/>`,
            UNIVERSITY: `<img src="./assets/monopoly-life/university.png"/>`,
            ENTERPRISE: `<img src="./assets/monopoly-life/enterprise.png"/>`,
            VOYAGE: `<img src="./assets/monopoly-life/voyage.png"/>`,
            WELFARE: `<img src="./assets/monopoly-life/welfare.png"/>`,
            MOVIES: `<img src="./assets/monopoly-life/movies.png"/>`,
            MINING: `<img src="./assets/monopoly-life/mining.png"/>`,
            SPACE: `<img src="./assets/monopoly-life/space.png"/>`,
            VACATIONAL: `<img src="./assets/monopoly-life/vacational.png"/>`,
        }

        class Role {
            id = Randoms.uuid()
            name = ''
            avatar = ''
            color = ''
            targetRiches = 0
            targetRepute = 0;
            targetHapply = 0
            /**
             * @param {Role} role
             */
            constructor(role) {
                for (const key in role) {
                    this[key] = role[key]
                }
            }
        }

        class Player extends Role {
            /** 财富 */
            riches = 5000
            /** 薪水 */
            salary = 2000
            /** 声望 */
            repute = 0;
            /** 幸福 */
            happy = 0;

            /** 位置 */
            position = 0;
            /** 位置类型 */
            positionType = PositionTypeEnum.LOOP
            /** 历史记录 */
            history = []
            /** 行动状态 */
            actionState = PlayerActionEnum.NONE

            /**
             * @param {Player} player
             */
            constructor(player) {
                super(player)
                for (const key in player) {
                    this[key] = player[key]
                }

                this.save = function () {
                    this.history.push({
                        position: this.position,
                        positionType: this.positionType
                    })
                }
            }


        }

        class SceneStation {
            /** @type {Player} */
            curPlayer = null
            /** @type {Player[]} */
            allPlayers = []
            dicePoints = 0
            /** @type {Station}  */
            prevStation = null
        }

        class Station {
            /** @type {string} */
            id = ""
            /** @type {string} */
            left = ""
            /** @type {string} */
            top = ""
            /** @type {string} */
            width = ""
            /** @type {string} */
            height = ""
            /** @type {string} */
            name = ""
            /** @type {string} */
            description = ""
            /** @type {HTMLDivElement} */
            dom = null
            /**
             * 经过
             * @param {SceneStation} scene
             */
            via‌ = (scene) => { }
            /**
             * 停止
             * @param {SceneStation} scene
             */
            stop = (scene) => { }
            /**
             * 离开
             * @param {SceneStation} scene
             */
            leave
            /**
             * @param {Station} station
             */
            constructor(station) {
                for (const key in station) {
                    this[key] = station[key]
                }
            }
        }


        /** 日志控件 左下角
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const logContainer = function () {
            const fragment = templateLoad('#log-template')
            const closeDom = fragment.shadowRoot.querySelector('.log-icon-close')
            const bodyDom = fragment.shadowRoot.querySelector('.log-body')
            closeDom.addEventListener('click', () => fragment.classList.toggle('close'))
            /** 窗口日志打印
             * @param {string} str
             */
            const log = (str) => {
                bodyDom.innerHTML += `<div class="log-item">${str}</div>`
                bodyDom.scrollTop = Number.MAX_SAFE_INTEGER;
            }
            log("日志框初始化完成")
            return {
                fragment,
                log
            }
        }();

        /** 玩家控件 右上角
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const playerContainer = function () {
            const fragment = templateLoad("#players-template")
            fragment.classList.add('close');
            /**
             * 玩家加入
             * @param {Player[]} players
             */
            let join = async (players) => {
                for (const player of players) {
                    fragment.shadowRoot.innerHTML += `
                        <div class="player-item" data-id="${player.id}">
                            <div class="player-avatar" style="background-image:url(${player.avatar})"></div>
                            <div class="player-base-info">
                                <div class="player-riches">
                                    <div class="player-icon">
                                         ${ICON_CONFIG.RICHES}
                                    </div>
                                    <div class="player-value">${player.riches}</div>
                                </div>
                                <div class="player-salary">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.SALARY}
                                    </div>
                                    <div class="player-value">${player.salary}</div>
                                </div>
                                <div class="player-repute">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.REPUTE}  
                                    </div>
                                    <div class="player-value">${player.repute}</div>
                                </div>
                                <div class="player-happy">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.HAPPY}
                                    </div>
                                    <div class="player-value">${player.happy}</div>
                                </div>
                            </div>

                            <div class="player-more">
                                <div class="player-target-container">
                                    <div class="player-target-title">
                                        目标值
                                    </div>
                                    <div class="player-target-body">
                                        <div class="player-target-item">
                                            <div class="player-icon">
                                                ${ICON_CONFIG.RICHES}
                                            </div>
                                            <div class="player-value">${player.targetRiches}000</div>
                                        </div>
                                        <div class="player-target-item">
                                            <div class="player-icon">
                                                ${ICON_CONFIG.REPUTE}
                                            </div>
                                            <div class="player-value">${player.targetRepute}</div>
                                        </div>
                                        <div class="player-target-item">
                                            <div class="player-icon">
                                                ${ICON_CONFIG.HAPPY}
                                            </div>
                                            <div class="player-value">${player.targetHapply}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="player-exp-container">
                                    <div class="player-exp-title">
                                        经验
                                    </div>
                                    <div class="player-exp-body">
                                        <div class="player-icon">
                                            无
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                }
                fragment.classList.remove('close')
            }


            /**
             * 玩家更新
             * @param {Player[]} players
             */
            let upd = async (players) => {
                for (const player of players) {
                    let dom = fragment.shadowRoot.querySelector(`.player-item[data-id="${player.id}"]`)
                    dom.querySelector('.player-riches .player-value').textContent = player.riches
                    dom.querySelector('.player-salary .player-value').textContent = player.salary
                    dom.querySelector('.player-repute .player-value').textContent = player.repute
                    dom.querySelector('.player-happy .player-value').textContent = player.happy
                }
            }

            /**
             * 下一个玩家
             * @param {Player} player
             */
            let next = async (player) => {
                let lastDom = fragment.shadowRoot.querySelector('.player-item.active');
                let currDom = fragment.shadowRoot.querySelector(`.player-item[data-id="${player.id}"]`);
                if (lastDom) lastDom.classList.remove('active')
                currDom.classList.add('active')
            }
            logContainer.log('玩家控件初始化完成')
            return {
                fragment,
                join,
                upd,
                next
            }
        }();

        /** 骰子控件 弹窗
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const diceContainer = await async function () {
            const fragment = templateLoad('#dice-template')
            const diceImages = await Promise.all([
                './assets/monopoly/1.png',
                './assets/monopoly/2.png',
                './assets/monopoly/3.png',
                './assets/monopoly/4.png',
                './assets/monopoly/5.png',
                './assets/monopoly/6.png',
            ].map(u => loadImage(u)))
            /** @type {HTMLDivElement} */
            const diceItemContainerDom = fragment.querySelector('.dice-item-container')
            /** @type {HTMLDivElement} */
            const confirmDom = fragment.querySelector('.game-btn-confirm')
            /** 
             * @param {number} count
             * @return {Promise<number>}
             */
            const open = (count) => {
                return new Promise((resolve) => {
                    for (let i = 0; i < diceItemContainerDom.children.length; i++) {
                        const dom = diceItemContainerDom.children.item(i)
                        dom.classList.add('hidden')
                    }
                    for (let i = 0; i < count; i++) {
                        /** @type {HTMLDivElement} */
                        const dom = diceItemContainerDom.children.item(i)
                        dom.classList.remove('hidden')
                        dom.style.backgroundImage = `url(${diceImages[0].src})`
                    }
                    diceContainerDom.classList.remove('close')

                    const confirmFunc = async function () {
                        // 执行🎲
                        const diceItemDomList = diceItemContainerDom.querySelectorAll('.dice-item:not(.hidden)')
                        // 结果
                        const result = {}
                        // 循环15次约等于1.5s
                        for (let i = 0; i < 15; i++) {
                            await wait(100);
                            for (let j = 0; j < diceItemDomList.length; j++) {
                                /** @type {HTMLDivElement} */
                                const diceItemDom = diceItemDomList.item(j);
                                const val = Randoms.int(0, 6)
                                diceItemDom.style.backgroundImage = `url(${diceImages[val].src})`
                                result[j] = val + 1
                            }
                        }
                        const total = Maths.sum(Object.values(result))
                        diceContainerDom.classList.add('close')
                        resolve(total)
                    }
                    confirmDom.removeEventListener("click", confirmFunc)
                    confirmDom.addEventListener("click", confirmFunc)
                })
            }
            logContainer.log("骰子控件加载完成")
            return {
                fragment,
                open
            }
        }()


        /**
         * 角色控件 弹窗
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const roleContainer = await async function () {
            const roleList = [
                new Role({
                    name: '小黑',
                    avatar: './assets/monopoly/black.jpg',
                    color: 'black'
                }),
                new Role({
                    name: '小红',
                    avatar: './assets/monopoly/red.jpg',
                    color: 'red'
                }),
                new Role({
                    name: '小黄',
                    avatar: './assets/monopoly/yellow.jpg',
                    color: 'yellow'
                }),
                new Role({
                    name: '小蓝',
                    avatar: './assets/monopoly/blue.jpg',
                    color: 'blue'
                })
            ]
            await Promise.all(roleList.map(r => loadImage(r.avatar)))
            let roleItemHtml = ``
            let targetItemHtml = ``
            for (let i = 0; i < roleList.length; i++) {
                const role = roleList[i];
                roleItemHtml += `
                    <div class="role-item active">
                        <div class="role-item-avatar" style="background-image:url(${role.avatar})"></div>
                        <div class="role-item-name">${role.name}</div>
                    </div> 
                `

                targetItemHtml += `
                    <div class="target-item">
                        <div class="target-item-content">
                            ${ICON_CONFIG.RICHES}
                            <input type="number" placeholder="财富" max="60" min="0" step="1"/>
                        </div>
                        <div class="target-item-content">
                            ${ICON_CONFIG.REPUTE}  
                            <input type="number" placeholder="名誉" max="60" min="0" step="1"/>
                        </div>
                        <div class="target-item-content">
                            ${ICON_CONFIG.HAPPY}
                            <input type="number" placeholder="快乐" max="60" min="0" step="1"/>
                        </div>
                    </div>
                `
            }

            const template = `
                <div class="role-container close">
                    <div class="role-header">
                        <div class="role-header-title">
                            角色选择
                        </div>
                    </div>
                    <div class="role-body">
                        <div class="role-item-container">
                            ${roleItemHtml}
                        </div>
                        <div class="target-item-container">
                            ${targetItemHtml}
                        </div>
                        <div class="target-hint">
                            输入财富、名誉、快乐的预定目标，财富1000元为1分，三项目标加起来必须刚好60分。
                        </div>
                        <div class="game-btn-confirm">确认选择</div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const roleContainerDom = fragment.querySelector('.role-container')
            const roleItemContainerDom = roleContainerDom.querySelector('.role-item-container')
            const targetItemContainerDom = roleContainerDom.querySelector('.target-item-container')
            roleItemContainerDom.querySelectorAll('.role-item').forEach((dom) => {
                dom.addEventListener('click', function () {
                    if (dom.classList.contains('active')) {
                        if (roleItemContainerDom.querySelectorAll('.role-item.active').length < 3) return
                        dom.classList.remove('active')
                    }
                    else {
                        dom.classList.add('active')
                    }
                })
            })

            /** @type {HTMLDivElement} */
            const confirmDom = roleContainerDom.querySelector('.game-btn-confirm')

            logContainer.log('角色控件加载完成')
            /**
             * @return {Promise<roles[]>}
             */
            const open = () => {
                roleContainerDom.classList.remove('close')
                return new Promise((resolve) => {
                    confirmDom.addEventListener("click", () => {
                        console.log('选中角色');
                        let selected = []
                        let roles = roleItemContainerDom.querySelectorAll('.role-item')
                        let targets = targetItemContainerDom.querySelectorAll('.target-item')
                        let valid = true
                        roles.forEach((role, roleIndex) => {
                            let target = targets.item(roleIndex)
                            target.classList.remove('error')
                            target.classList.remove('valid')
                            if (role.classList.contains('active')) {
                                let inputs = target.querySelectorAll('input')
                                let targetRiches = +inputs.item(0).value
                                let targetRepute = +inputs.item(1).value
                                let targetHapply = +inputs.item(2).value
                                selected.push(new Role({
                                    ...roleList[roleIndex],
                                    targetRiches,
                                    targetRepute,
                                    targetHapply
                                }))
                                if (targetRiches + targetRepute + targetHapply != 60) {
                                    target.classList.add('error')
                                    valid = false;
                                }
                                else {
                                    target.classList.add('valid')
                                    valid = true
                                }
                            }
                        })

                        if (valid) {
                            resolve(selected);
                        }
                    })

                })
            }
            return {
                fragment,
                open
            }
        }()


        /**
         * 战斗控件
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const fightContainer = await async function () {


            const open = () => {
                // p1 vs p2

                // 掷骰子

                // 结果
            }

            return {
                open
            }
        }()


        /**
         * 获取机会[经验]卡控件
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const chanceContainer = await async function () {
            const open = (count) => {

            }
        }()


        /**
         * 卡包控件
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const cardHolderContainer = await async function () {
            const open = function () {

            }

            return {
                open
            }

        }()



        /**
         * 医院控件
         * @author 	 linyisonger
         * @date 	 2024-12-12
         */
        const hospitalContainer = await async function () {
            const diceImages = await Promise.all([
                './assets/monopoly/1.png',
                './assets/monopoly/2.png',
                './assets/monopoly/3.png',
                './assets/monopoly/4.png',
                './assets/monopoly/5.png',
                './assets/monopoly/6.png',
            ].map(u => loadImage(u)))
            const template = `
                <div class="hospital-container close">
                    <div class="logo">
                        <img src="./assets/monopoly-life/hospital.png"/> 
                    </div>
                    <div class="hospital-content">
                        <div class="hospital-message">
                            不可使用机会卡或经验卡离开此格，需掷骰决定如何离开医院：
                        </div>
                        <div class="hospital-list">
                            <div class="hospital-item">
                                <img src="${diceImages[0].src}"/>
                                <img src="${diceImages[1].src}"/>
                                再休养一回合
                            </div>
                            <div class="hospital-item">
                                <img src="${diceImages[2].src}"/>
                                <img src="${diceImages[3].src}"/>
                                <img src="${diceImages[4].src}"/>
                                <img src="${diceImages[5].src}"/>
                                付薪级一半的医药费给有医学学位的人下回合出院
                            </div>
                            <div class="hospital-item">
                                (若无人有医学学位则给银行)
                            </div>                        
                        </div>
                        <div class="hospital-footer">
                            <div class="hospital-dice">
                                <img src="${diceImages[4].src}"/>
                            </div>
                            <div class="game-btn-confirm">开始转动</div>
                        </div>
                       
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const hospitalContainerDom = fragment.querySelector('.hospital-container')
            const confirmDom = hospitalContainerDom.querySelector('.game-btn-confirm')


            /**
             * @return {Promise<number>}
             */
            const open = function () {
                hospitalContainerDom.classList.remove('close')
                return new Promise((resolve) => {
                    const confirmFunc = async function () {
                        // 执行🎲
                        /** @type {HTMLImageElement} */
                        const diceItemDom = hospitalContainerDom.querySelector('.hospital-dice img')
                        // 结果
                        let total = 0
                        // 循环15次约等于1.5s
                        for (let i = 0; i < 15; i++) {
                            await wait(100);
                            const val = Randoms.int(0, 6)
                            diceItemDom.setAttribute('src', `${diceImages[val].src}`)
                            total = val + 1
                        }
                        hospitalContainerDom.classList.add('close')
                        resolve(total)
                    }
                    confirmDom.removeEventListener("click", confirmFunc)
                    confirmDom.addEventListener("click", confirmFunc)
                })
            }

            return {
                fragment,
                open
            }
        }()

        /**
         * 公园控件
         * @author 	 linyisonger
         * @date 	 2024-12-12
         */
        const parkContainer = await async function () {
            const diceImages = await Promise.all([
                './assets/monopoly/1.png',
                './assets/monopoly/2.png',
                './assets/monopoly/3.png',
                './assets/monopoly/4.png',
                './assets/monopoly/5.png',
                './assets/monopoly/6.png',
            ].map(u => loadImage(u)))
            const template = `
                <div class="park-container close">
                    <div class="logo">
                        <img src="./assets/monopoly-life/park.png"/> 
                    </div>
                    <div class="park-content">
                        <div class="park-message">
                            不可使用机会卡或经验卡离开此格，投掷一骰，若点数为双数，下回合即可离开：
                        </div>
                        <div class="park-list">
                            <div class="park-item">
                                <img src="${diceImages[1].src}"/>
                                <img src="${diceImages[3].src}"/> 
                                <img src="${diceImages[5].src}"/>
                                下回合离开
                            </div>
                            <div class="park-item">
                                <img src="${diceImages[0].src}"/>
                                <img src="${diceImages[2].src}"/>
                                <img src="${diceImages[4].src}"/>
                                下回合继续
                            </div>           
                        </div>
                        <div class="park-footer">
                            <div class="park-dice">
                                <img src="${diceImages[4].src}"/>
                            </div>
                            <div class="game-btn-confirm">开始转动</div>
                        </div>
                       
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const parkContainerDom = fragment.querySelector('.park-container')
            const confirmDom = parkContainerDom.querySelector('.game-btn-confirm')


            /**
             * @return {Promise<number>}
             */
            const open = function () {
                parkContainerDom.classList.remove('close')
                return new Promise((resolve) => {
                    const confirmFunc = async function () {
                        // 执行🎲
                        /** @type {HTMLImageElement} */
                        const diceItemDom = parkContainerDom.querySelector('.park-dice img')
                        // 结果
                        let total = 0
                        // 循环15次约等于1.5s
                        for (let i = 0; i < 15; i++) {
                            await wait(100);
                            const val = Randoms.int(0, 6)
                            diceItemDom.setAttribute('src', `${diceImages[val].src}`)
                            total = val + 1
                        }
                        parkContainerDom.classList.add('close')
                        resolve(total)
                    }
                    confirmDom.removeEventListener("click", confirmFunc)
                    confirmDom.addEventListener("click", confirmFunc)
                })
            }

            return {
                fragment,
                open
            }
        }()



        /**
         * 彩票店控件
         * @author 	 linyisonger
         * @date 	 2024-12-16
         */
        const lotteryContainer = await async function () {
            const diceImages = await Promise.all([
                './assets/monopoly/1.png',
                './assets/monopoly/2.png',
                './assets/monopoly/3.png',
                './assets/monopoly/4.png',
                './assets/monopoly/5.png',
                './assets/monopoly/6.png',
            ].map(u => loadImage(u)))



            const template = `
                <div class="lottery-container close">
                    <div class="logo">
                        <img src="./assets/monopoly-life/lottery.png"/> 
                    </div>
                    <div class="lottery-content">
                        <div class="lottery-message">
                            每人可轮流选择是否执行以下动作：掷一颗骰并根据掷出点数失去或获得金钱
                         </div>
                        <div class="lottery-list">
                            <div class="lottery-item">
                                <div style="width:200px">
                                    <img src="${diceImages[0].src}"/>
                                    <img src="${diceImages[1].src}"/>
                                    <img src="${diceImages[2].src}"/>
                                    <img src="${diceImages[3].src}"/> 
                                </div>
                                <div class="flex-row-center" style="color:red">
                                    ${ICON_CONFIG.RICHES}-1000元
                                </div>
                            </div>
                            <div class="lottery-item">
                                <div style="width:200px">
                                    <img src="${diceImages[4].src}"/>
                                    <img src="${diceImages[5].src}"/>
                                </div>
                                <div class="flex-row-center" style="color:green">
                                    ${ICON_CONFIG.RICHES}+5000元
                                </div>        
                            </div>           
                        </div>
                        <div class="lottery-player-list">
                        </div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const lotteryContainerDom = fragment.querySelector('.lottery-container')
            const confirmDom = lotteryContainerDom.querySelector('.game-btn-confirm')
            const lotteryPlayerListDom = fragment.querySelector('.lottery-player-list')


            /**
             * @param {Player[]} players
             * @return {Promise<number>}
             */
            const open = function (players) {
                lotteryContainerDom.classList.remove('close')
                return new Promise((resolve) => {
                    let result = {}
                    let resultProxy = new Proxy(result, {
                        get(result, prop) {
                            return result[prop]
                        },
                        async set(result, prop, value) {
                            result[prop] = value;

                            if (Object.keys(result).length === players.length) {
                                await wait(500);
                                lotteryContainerDom.classList.add('close')
                                await wait(500);
                                resolve(Object.values(result))
                            }
                        },
                    })
                    lotteryPlayerListDom.innerHTML = ''
                    players.forEach(function (player, index) {
                        let playerItemTemplate = `
                            <div class="player-operate">
                                <div class="player-item">
                                    <div class="player-avatar" style="background-image:url(${player.avatar});border-color:${player.color}"></div>
                                    <div class="player-name">${player.name}</div>
                                </div>
                                <div class="operate-item">
                                    <div class="operate-dice">
                                        <img src="${diceImages[4].src}"/>
                                    </div>
                                    <div class="game-btn-confirm">购买</div>
                                    <div class="game-btn-confirm">放弃</div>
                                </div>
                            </div>
                        `
                        let playerFragment = createFragment(playerItemTemplate)
                        lotteryPlayerListDom.appendChild(playerFragment)
                        let playerOperateDom = lotteryPlayerListDom.querySelectorAll('.player-operate').item(index)
                        let operateItemDom = playerOperateDom.querySelector('.operate-item')
                        let confirmListDom = playerOperateDom.querySelectorAll('.game-btn-confirm')
                        let buyDom = confirmListDom.item(0);
                        let abandonDom = confirmListDom.item(1)

                        const buyFunc = async () => {
                            let operateDiceDom = operateItemDom.querySelector('.operate-dice img')
                            buyDom.remove();
                            abandonDom.remove()
                            // 结果
                            let total = 0
                            // 循环15次约等于1.5s
                            for (let i = 0; i < 15; i++) {
                                await wait(100);
                                const val = Randoms.int(0, 6)
                                operateDiceDom.setAttribute('src', `${diceImages[val].src}`)
                                total = val + 1
                            }

                            if (total > 4) {
                                let riches = 5000;
                                operateItemDom.innerHTML = `${ICON_CONFIG.RICHES}<span style="color:green">+${riches}元</span>`
                                resultProxy[index] = riches
                            }
                            else {
                                let riches = -1000;
                                operateItemDom.innerHTML = `${ICON_CONFIG.RICHES}<span style="color:red">${riches}元</span>`
                                resultProxy[index] = riches
                            }
                        }
                        buyDom.removeEventListener("click", buyFunc)
                        buyDom.addEventListener("click", buyFunc)

                        const abandonFunc = () => {
                            operateItemDom.innerHTML = `放弃`
                            resultProxy[index] = 0
                        }
                        abandonDom.removeEventListener("click", abandonFunc)
                        abandonDom.addEventListener("click", abandonFunc)
                    })
                })
            }

            return {
                fragment,
                open
            }
        }()
        /**
         * 股票市场
         * @author 	 linyisonger
         * @date 	 2024-12-12
         */
        const stockMarketContainer = await async function () {

        }();


        /**
         * 对话框控件
         * @author 	 linyisonger
         * @date 	 2024-12-03
         */
        const dialogContainer = function () {
            const template = `
                <div class="dialog-container close">
                    <div class="dialog-header">
                        <div class="dialog-header-title">
                            对话框
                        </div>
                    </div>
                    <div class="dialog-body">
                        <div class="dialog-body-content">
                            请选择你想要的选项
                        </div>
                        <div class="dialog-body-options">
                            <div class="dialog-body-option">
                                A
                            </div>
                            <div class="dialog-body-option">
                                B
                            </div>
                            <div class="dialog-body-option">
                                C
                            </div>
                        </div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const dialogContainerDom = fragment.querySelector('.dialog-container')
            class DialogOpenConfig {
                title = ''
                content = ''
                options = []
            }

            /**
             * 打开弹窗
             * @param {DialogOpenConfig} config
             */
            const open = function (config) {
                return new Promise((resolve) => {
                    dialogContainerDom.classList.remove('close')
                    const titleDom = dialogContainerDom.querySelector('.dialog-header-title')
                    const contentDom = dialogContainerDom.querySelector('.dialog-body-content')
                    const optionsDom = dialogContainerDom.querySelector('.dialog-body-options')
                    titleDom.textContent = config.title;
                    contentDom.innerHTML = config.content
                    optionsDom.innerHTML = '';
                    for (let i = 0; i < config.options.length; i++) {
                        const option = config.options[i];
                        const optionDom = document.createElement('div')
                        optionDom.classList.add('dialog-body-option')
                        optionDom.innerHTML = option
                        optionDom.addEventListener("click", function () {
                            dialogContainerDom.classList.add('close')
                            resolve(i)
                        })
                        optionsDom.appendChild(optionDom)
                    }
                })

            }

            return {
                fragment,
                open
            }
        }()

        /**
         * 地图控件
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const mapContainer = await async function () {
            let template = `
                <div class="map-container"></div>
            `;
            let fragment = createFragment(template)

            /** @type {HTMLDivElement} */
            let mapContainerDom = fragment.querySelector('.map-container')
            let screenWidth = document.body.clientWidth
            let screenHeight = document.body.clientHeight

            // 加载图片背景
            let mapImage = await loadImage('./assets/monopoly-life/map.jpg')
            mapContainerDom.style.backgroundImage = `url(${mapImage.src})`
            mapContainerDom.style.width = mapImage.width / 2 + 'px'
            mapContainerDom.style.height = mapImage.height / 2 + 'px'
            // 溢出距离
            let overflowDistance = 100
            let { lookAt } = dragging(mapContainerDom, { minX: -mapImage.width / 2 + screenWidth - overflowDistance, maxX: 0 + overflowDistance, minY: -mapImage.height / 2 + screenHeight - overflowDistance, maxY: 0 + overflowDistance })
            logContainer.log("加载地图背景完成")


            class PlayerChanged {
                /** 财富 */
                riches = 0
                /** 薪水 */
                salary = 0
                /** 声望 */
                repute = 0
                /** 幸福 */
                happy = 0
                /** 行动状态 */
                actionState = PlayerActionEnum.NONE
            }

            class EmploymentEntranceCondition {
                /** 财富 */
                riches = 0
            }

            /**
             * 数值变化
             * @param {Player} player
             * @param {PlayerChanged} changed
             */
            function playerChange(player, changed) {
                if (Maths.sum(Object.values(changed)) == 0) {
                    logContainer.log(`玩家[${player.name}]没有任何变化`)
                    return
                }; // 没有发生改变
                let str = `<div class="flex-row-center">玩家[${player.name}]`
                if (changed.riches) {
                    str += `${ICON_CONFIG.RICHES}`
                    if (changed.riches > 0) str += `<span style="color:green">+${changed.riches}元</span>`
                    else str += `<span style="color:red">${changed.riches}元</span>`
                    player.riches += changed.riches
                }
                if (changed.salary) {
                    str += `${ICON_CONFIG.SALARY}`
                    if (changed.salary > 0) str += `<span style="color:green">+${changed.salary}元</span>`
                    else str += `<span style="color:red">${changed.salary}元</span>`
                    player.salary += changed.salary
                }
                if (changed.happy) {
                    if (changed.happy > 0) str += `<span style="color:green">+${changed.happy}</span>`
                    else str += `<span style="color:red">${changed.happy}</span>`
                    str += `${ICON_CONFIG.HAPPY}`
                    player.happy += changed.happy
                }
                if (changed.repute) {
                    if (changed.repute > 0) str += `<span style="color:green">+${changed.repute}</span>`
                    else str += `<span style="color:red">${changed.repute}</span>`
                    str += `${ICON_CONFIG.REPUTE}`
                    player.repute += changed.repute
                }
                if (changed.actionState === PlayerActionEnum.AGAIN) str += '<span style="color:green">再来一次</span>'
                if (changed.actionState === PlayerActionEnum.PAUSE) str += '<span style="color:red">暂停一次</span>'
                str += '</div>'
                logContainer.log(str)
                playerContainer.upd([player])
            }

            /**
             * 表格展示
             * @param {SceneStation} scene 
             */
            function table(scene) {
                // 是否纯文本
                let isText = !/<td.*?>/.test(this.description);
                let description = this.description;
                if (isText) description = `<tr><td>${description}</td></tr>`
                const table = `
                    <table class="log-item-table">
                        <tbody>
                            <tr>
                                <td colspan="${isText ? 1 : 2}">${this.name}</td>
                            </tr>
                            ${description}
                        </tbody>
                    </table>
                `

                console.log(table);
                logContainer.log(`玩家[${scene.curPlayer.name}]触发事件${table}`)
            }

            /**
             * 领取工资
             * @param {SceneStation} scene 
             */
            function salaryCollection(scene) {
                table.call(this, scene)
                playerChange(scene.curPlayer, { riches: scene.curPlayer.salary })
            }

            /**
             * 付所得税
             * @param {SceneStation} scene 
             */
            function payIncomeTax(scene) {
                table.call(this, scene)
                for (const player of [scene.curPlayer, ...scene.allPlayers]) {
                    let tax = 0
                    if (player.salary < 3000) tax = -150;
                    if (player.salary >= 4000 && player.salary <= 6000) tax = -1500
                    if (player.salary > 6000) tax = -3000;
                    playerChange(player, { riches: tax })
                }
            }

            /**
             * 付娱乐税
             * @param {SceneStation} scene 
             */
            function payEntertainmentTax(scene) {
                table.call(this, scene)
                for (const player of [scene.curPlayer, ...scene.allPlayers]) {
                    let tax = 0
                    if (player.happy > 20) tax = -1000;
                    else if (player.happy > 5) tax = -2000;
                    else if (player.happy > 1) tax = -3000;
                    playerChange(player, { riches: tax })
                }
            }

            /**
            * 就业入口
            * @param {keyof PositionTypeEnum} type 
            */
            function employmentEntrance(type) {
                /**
                * 就业入口
                * @param {SceneStation} scene 
                */
                return async function (scene) {
                    table.call(this, scene)
                    // 检查是否有经验 
                    let isHasExp = false;
                    let options = []

                    if (isHasExp) options.push('进入道路')
                    else options.push('进入道路(-500元)')
                    options.push('不进入')

                    let selected = await dialogContainer.open({
                        title: "提示",
                        content: `
                            <div class="flex-column-center">
                                <div style="width:100px">
                                    ${ICON_CONFIG[type]}
                                </div>
                                <div>
                                    到达[${this.name}]请选择
                                </div>
                                <div>
                                    ${this.description}
                                </div>
                            </div>
                        `,
                        options
                    })

                    if (selected == 0) {
                        scene.curPlayer.positionType = PositionTypeEnum[type];
                        scene.curPlayer.position = -1;
                    }
                }
            }


            /**
             * 普通事件
             * @param {(scene:SceneStation)=>PlayerChanged} func
             */
            function ordinaryEvents(func) {
                /**
                 * @param {SceneStation} scene 
                 */
                return async function (scene) {
                    table.call(this, scene)

                    // 存在卡片 处理免疫负面事件

                    playerChange(scene.curPlayer, func(scene))
                }
            }


            /**
             * 移动事件
             * @param {keyof PositionTypeEnum} type
             * @param {number} index
             */
            function moveStation(type, index) {
                /**
                 * @param {SceneStation} scene 
                 */
                return async function (scene) {

                    let station = null;
                    let player = scene.curPlayer;

                    player.positionType = PositionTypeEnum[type]
                    player.position = index;

                    // 进入外圈
                    if (player.positionType == PositionTypeEnum.LOOP) {
                        station = loopStations[player.position % loopStations.length]; // 外圈站点
                    }
                    scene.prevStation = station;
                    logContainer.log(`玩家[${scene.curPlayer.name}]移动到[${station.name}]`)
                    station.stop?.(scene)
                }
            }

            /**
             * 出院名单 
             */
            let dischargeList = []
            /**
             * 离开医院
             * @param {SceneStation} scene 
             */
            async function leaveHospital(scene) {
                let dischargeIndex = dischargeList.findIndex(d => d === scene.curPlayer)
                // 出院
                if (dischargeIndex > -1) {
                    dischargeList.splice(dischargeIndex, 1)
                    return true;
                }
                let diceTotal = await hospitalContainer.open()
                // 再住一回合
                if (diceTotal == 1 || diceTotal == 2) return false;
                // 扣钱下回合出院



                dischargeList.push(scene.curPlayer)
                return false;
            }

            /**
             * 停留度假村
             * @param {SceneStation} scene 
             */
            async function stopVacational(scene) {
                table.call(this, scene)
                playerChange(scene.curPlayer, { happy: 2 })

                let options = [
                    `下回合多停留一次 +3${ICON_CONFIG.HAPPY}`,
                    '下回合离开'
                ]

                let selected = await dialogContainer.open({
                    title: "提示",
                    content: `
                            <div class="flex-column-center">
                                <div style="width:100px">
                                    ${ICON_CONFIG.VACATIONAL}
                                </div>
                                <div>
                                    到达[${this.name}]请选择
                                </div>
                            </div>
                        `,
                    options
                })

                if (selected == 0) {
                    scene.curPlayer.actionState = PlayerActionEnum.PAUSE
                    playerChange(scene.curPlayer, { happy: 3 })
                }
            }

            // 离开公园人员列表
            let exitParkList = []
            /**
             * 停留公园
             * @param {SceneStation} scene 
             */
            async function leaveOrStopPark() {
                let exitIndex = exitParkList.findIndex(d => d === scene.curPlayer)
                // 离开
                if (exitIndex > -1) {
                    exitParkList.splice(exitIndex, 1)
                    return true;
                }
                let diceTotal = await parkContainer.open()

                // 偶数离开
                if (diceTotal % 2 == 0) {
                    exitParkList.push(scene.curPlayer)
                }

                return false
            }



            /**
             * 停留彩票店
             * @param {SceneStation} scene 
             */
            async function stopLottery(scene) {
                table.call(this, scene)
                let players = [scene.curPlayer, ...scene.allPlayers];
                let result = await lotteryContainer.open(players)
                for (let i = 0; i < players.length; i++) {
                    const player = players[i];
                    result[i] && playerChange(player, { riches: result[i] })
                }
            }
            /**
             * 外圈
             * @type {Station[]}
             * @author 	 linyisonger
             * @date 	 2024-12-02
             */
            let loopStations = [
                {
                    id: "1",
                    left: "83.3%",
                    top: "83.3%",
                    width: "15.34%",
                    height: "15.34%",
                    name: '发薪日',
                    description: "经过或者停留此处，可领取与当前薪级相当的薪水",
                    via‌: salaryCollection,
                    stop: salaryCollection
                },
                {
                    id: "2",
                    left: "73.7%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "3",
                    left: "64.1%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '所有人付所得税',
                    description: ` 
                        <tr>
                            <td>薪级</td>
                            <td>需付税款</td>
                        </tr>
                        <tr>
                            <td>3千以下</td>
                            <td>200元</td>
                        </tr>
                        <tr>
                            <td>4千到6千</td>
                            <td>1500元</td>
                        </tr>
                        <tr>
                            <td>6千元以上</td>
                            <td>3000元</td>
                        </tr>
                    `,
                    stop: payIncomeTax
                },
                {
                    id: "4",
                    left: "54.6%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "5",
                    left: "45.1%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '农业开荒就业入口',
                    description: "就业条件：付500元务农资本或已有农业经验",
                    stop: employmentEntrance("AGRICULTURE")
                },
                {
                    id: "6",
                    left: "35.5%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "7",
                    left: "26%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '购买彩票',
                    description: "每人可轮流选择是否执行以下动作：掷一颗骰并根据掷出点数失去或获得金钱",
                    stop: stopLottery
                },
                {
                    id: "8",
                    left: "16.4%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: '大学进修就业入口',
                    description: "入学条件：付500元学费",
                    stop: employmentEntrance("UNIVERSITY")
                },
                {
                    id: "9",
                    left: "1%",
                    top: "83.3%",
                    width: "15.34%",
                    height: "15.34%",
                    name: '医院',
                    description: "",
                    leave: leaveHospital
                },
                {
                    id: "10",
                    left: "1%",
                    top: "73.6%",
                    width: "15.34%",
                    height: "9.5%",
                    name: '所有人付娱乐费',
                    description: `
                        <tr>
                            <td><div class="flex-row-center">所持有${ICON_CONFIG.HAPPY}</div></td>
                            <td>需付款</td>
                        </tr>
                        <tr>
                            <td><div class="flex-row-center">1~5${ICON_CONFIG.HAPPY}</div></td>
                            <td>3000元</td>
                        </tr>
                        <tr>
                            <td><div class="flex-row-center">6~20${ICON_CONFIG.HAPPY}</div></td>
                            <td>2000元</td>
                        </tr>
                        <tr>
                            <td><div class="flex-row-center">21${ICON_CONFIG.HAPPY}以上</div></td>
                            <td>1000元</td>
                        </tr>
                    `,
                    stop: payEntertainmentTax
                },
                {
                    id: "11",
                    left: "1%",
                    top: "64%",
                    width: "15.34%",
                    height: "9.5%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "12",
                    left: "1%",
                    top: "54.7%",
                    width: "15.34%",
                    height: "9.2%",
                    name: '企业经营就业入口',
                    description: "就业条件：付5000元雇佣员工或已有普通学位或已有企业经验",
                    stop: employmentEntrance("ENTERPRISE")
                },
                {
                    id: "13",
                    left: "1%",
                    top: "45.2%",
                    width: "15.34%",
                    height: "9.4%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "14",
                    left: "1%",
                    top: "35.6%",
                    width: "15.34%",
                    height: "9.5%",
                    name: '画廊',
                    description: ""
                },
                {
                    id: "15",
                    left: "1%",
                    top: "26.2%",
                    width: "15.34%",
                    height: "9.4%",
                    name: '航海就业入口',
                    description: ``,
                    stop: employmentEntrance("VOYAGE")
                },
                {
                    id: "16",
                    left: "1%",
                    top: "16.6%",
                    width: "15.34%",
                    height: "9.4%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "17",
                    left: "1%",
                    top: "1.2%",
                    width: "15.34%",
                    height: "15.34%",
                    name: '三亚度假',
                    description: `
                        <tr>
                            <td>停留此处+2${ICON_CONFIG.HAPPY}</td>
                        </tr>
                        <tr>
                            <td>可选择下回合多停留一次+3${ICON_CONFIG.HAPPY}(限额外停留一次)</td>
                        </tr>
                    `,
                    stop: stopVacational
                },
                {
                    id: "18",
                    left: "16.5%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "19",
                    left: "26%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '汽车展销会',
                    description: ""
                },
                {
                    id: "20",
                    left: "35.5%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '公益事业就业入口',
                    description: "",
                    stop: employmentEntrance("WELFARE")
                },
                {
                    id: "21",
                    left: "45%",
                    top: "1.2%",
                    width: "9.6%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "22",
                    left: "54.7%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '商场',
                    description: ""
                },
                {
                    id: "23",
                    left: "64.2%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '电影拍摄就业入口',
                    description: "",
                    stop: employmentEntrance("MOVIES")
                },
                {
                    id: "24",
                    left: "73.7%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "25",
                    left: "83.2%",
                    top: "1.2%",
                    width: "15.44%",
                    height: "15.34%",
                    name: '公园板凳',
                    description: "不可使用机会卡或经验卡离开此格，投掷一骰，若点数为双数，下回合即可离开",
                    stop: leaveOrStopPark,
                    leave: leaveOrStopPark
                },
                {
                    id: "26",
                    left: "83.2%",
                    top: "16.6%",
                    width: "15.44%",
                    height: "9.5%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "27",
                    left: "83.2%",
                    top: "26.2%",
                    width: "15.44%",
                    height: "9.5%",
                    name: '股票市场',
                    description: ""
                },
                {
                    id: "28",
                    left: "83.2%",
                    top: "35.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: '采矿开发就业入口',
                    description: "",
                    stop: employmentEntrance("MINING")

                },
                {
                    id: "29",
                    left: "83.2%",
                    top: "45.3%",
                    width: "15.44%",
                    height: "9.4%",
                    name: '机会',
                    description: ""
                },
                {
                    id: "30",
                    left: "83.2%",
                    top: "54.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: '许愿井',
                    description: ""
                },
                {
                    id: "31",
                    left: "83.2%",
                    top: "64.3%",
                    width: "15.44%",
                    height: "9.4%",
                    name: '太空探险就业入口',
                    description: "",
                    stop: employmentEntrance("SPACE")
                },
                {
                    id: "32",
                    left: "83.2%",
                    top: "73.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: '获诺贝尔奖',
                    description: ""
                }
            ].map((item) => new Station(item))

            /**
             * 内圈
             * @type {{ [x: number]: Station[];}}
             * @author 	 linyisonger
             * @date 	 2024-11-30
             */
            let insideStations = {
                // 农业
                [PositionTypeEnum.AGRICULTURE]: [
                    {
                        id: "1",
                        left: "45.1%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '土地肥沃适合耕种',
                        description: `+2${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 2 } })
                    },
                    {
                        id: "2",
                        left: "45.1%",
                        top: "73.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '研发新种改良作物',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "3",
                        left: "45.1%",
                        top: "69.01%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发展环保农业',
                        description: `+5${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 5 } })
                    },
                    {
                        id: "4",
                        left: "45.1%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '夏季收成',
                        description: "+🎲×1000元",
                        stop: ordinaryEvents((scene) => { return { riches: scene.dicePoints * 1000 } })
                    },
                    {
                        id: "5",
                        left: "40.4%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '有机饲料家畜健康',
                        description: `+2${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 4, repute: 2 } })
                    },
                    {
                        id: "6",
                        left: "35.6%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发生家畜传染病',
                        description: "-3000元",
                        stop: ordinaryEvents((scene) => { return { riches: -3000 } })
                    },
                    {
                        id: "7",
                        left: "35.6%",
                        top: "69.11%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '秋季大丰收',
                        description: "+5000元",
                        stop: ordinaryEvents((scene) => { return { riches: 5000 } })
                    },
                    {
                        id: "8",
                        left: "35.6%",
                        top: "73.86%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '大雪导致家禽冻死',
                        description: `-${ICON_CONFIG.HAPPY}/2`,
                        stop: ordinaryEvents((scene) => { return { happy: ~~(-scene.curPlayer.happy / 2) } })
                    },
                    {
                        id: "9",
                        left: "35.6%",
                        top: "78.56%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成立生技实验室',
                        description: "加一千元薪级别",
                        stop: ordinaryEvents((scene) => { return { salary: 1000 } })
                    }
                ].map((item) => new Station(item)),
                // 大学
                [PositionTypeEnum.UNIVERSITY]: [
                    {
                        id: "1",
                        left: "21.2%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '结识同学',
                        description: `+4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 4 } })
                    },
                    {
                        id: "2",
                        left: "21.2%",
                        top: "73.65%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '期中考睡过头',
                        description: "暂停一次",
                        stop: ordinaryEvents((scene) => { return { actionState: PlayerActionEnum.PAUSE } })
                    },
                    {
                        id: "3",
                        left: "26.0%",
                        top: "73.65%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '代表学校参加比赛',
                        description: `+2${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 2 } })
                    },
                    {
                        id: "4",
                        left: "26.0%",
                        top: "68.85%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '交错报告',
                        description: `-🎲×${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: -scene.dicePoints } })
                    },
                    {
                        id: "5",
                        left: "26.0%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成绩优异获奖学金',
                        description: "+1000元",
                        stop: ordinaryEvents((scene) => { return { riches: 1000 } })
                    },
                    {
                        id: "6",
                        left: "21.2%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '获选为学生会长',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "7",
                        left: "16.5%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '毕业旅行',
                        description: "抽两张机会卡"
                    },
                ].map((item) => new Station(item)),
                // 企业
                [PositionTypeEnum.ENTERPRISE]: [
                    {
                        id: "1",
                        left: "16.5%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '通过实习',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "2",
                        left: "21.2%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '简报优异',
                        description: `+4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 4 } })
                    },
                    {
                        id: "3",
                        left: "26%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '全勤奖金',
                        description: "+3000元",
                        stop: ordinaryEvents((scene) => { return { riches: 3000 } })
                    },
                    {
                        id: "4",
                        left: "30.8%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '误会客户失去合约',
                        description: "暂停一次",
                        stop: ordinaryEvents((scene) => { return { actionState: PlayerActionEnum.PAUSE } })
                    },
                    {
                        id: "5",
                        left: "30.8%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '研发新品备受瞩目',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "6",
                        left: "30.8%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成功扩展网店商场',
                        description: "+8000元",
                        stop: ordinaryEvents((scene) => { return { riches: 8000 } })
                    },
                    {
                        id: "7",
                        left: "30.8%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '投资准确',
                        description: "+4000元",
                        stop: ordinaryEvents((scene) => { return { riches: 4000 } })
                    },
                    {
                        id: "8",
                        left: "26.1%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '表现突出担任经理',
                        description: `+2${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { repute: 2, happy: 4 } })
                    },
                    {
                        id: "9",
                        left: "21.4%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '金融风暴周转失灵',
                        description: "马上移到公园",
                        stop: moveStation("LOOP", 24)
                    },
                    {
                        id: "10",
                        left: "21.4%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '品管不周客户退货',
                        description: `-${ICON_CONFIG.RICHES}/2`,
                        stop: ordinaryEvents((scene) => { return { riches: ~~(-scene.curPlayer.riches / 2) } })
                    },
                    {
                        id: "11",
                        left: "16.55%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '年终奖金',
                        description: "+6000元",
                        stop: ordinaryEvents((scene) => { return { riches: 6000 } })
                    },
                ].map((item) => new Station(item)),
                // 航海
                [PositionTypeEnum.VOYAGE]: [
                    {
                        id: "1",
                        left: "16.5%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '严重晕船',
                        description: "马上移到医院",
                        stop: moveStation("LOOP", 8)
                    },
                    {
                        id: "2",
                        left: "21.25%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '与海豚一同玩乐',
                        description: `+2${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 2 } })
                    },
                    {
                        id: "3",
                        left: "26%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现神秘海岛',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "4",
                        left: "30.7%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '遭遇暴风雨',
                        description: `-🎲×${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: -scene.dicePoints } })
                    },
                    {
                        id: "5",
                        left: "30.8%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '击退海盗救回同伴',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "6",
                        left: "30.8%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '荣升大副',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "7",
                        left: "26%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '打捞深海宝藏',
                        description: "+🎲×1000元",
                        stop: ordinaryEvents((scene) => { return { riches: scene.dicePoints * 1000 } })
                    },
                    {
                        id: "8",
                        left: "21.3%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '雾中迷航顺利脱险',
                        description: `+2${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { repute: 2, happy: 4 } })
                    },
                    {
                        id: "9",
                        left: "21.3%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '平安返乡',
                        description: "加一千元薪级",
                        stop: ordinaryEvents((scene) => { return { salary: 1000 } })
                    },
                ].map((item) => new Station(item)),
                // 公益
                [PositionTypeEnum.WELFARE]: [
                    {
                        id: "1",
                        left: "40.3%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '清扫街道美化市容',
                        description: `+2${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 2 } })
                    },
                    {
                        id: "2",
                        left: "40.3%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '植树造林',
                        description: `+🎲×${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: scene.dicePoints } })
                    },
                    {
                        id: "3",
                        left: "40.3%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '倡导环保',
                        description: `+🎲×${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: scene.dicePoints } })
                    },
                    {
                        id: "4",
                        left: "40.3%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '协助医师下乡义诊',
                        description: `+4${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 4 } })
                    },
                    {
                        id: "5",
                        left: "45%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '热心过度体力不支',
                        description: "马上移到医院",
                        stop: moveStation("LOOP", 8)
                    },
                    {
                        id: "6",
                        left: "49.8%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '建设农村电力管线',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "7",
                        left: "54.6%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '捐款助学',
                        description: "+🎲×1000元",
                        stop: ordinaryEvents((scene) => { return { riches: scene.dicePoints * 1000 } })
                    },
                    {
                        id: "8",
                        left: "54.6%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '爱心捐赠弱势群体',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "9",
                        left: "54.6%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '遭遇天灾',
                        description: "马上移到公园",
                        stop: moveStation("LOOP", 24)
                    },
                    {
                        id: "10",
                        left: "49.8%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '深入灾区救助难民',
                        description: `+10${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 10 } })
                    },
                    {
                        id: "11",
                        left: "49.8%",
                        top: "16.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '造桥铺路',
                        description: `+3${ICON_CONFIG.HAPPY}3${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { happy: 3, repute: 3 } })
                    },
                ].map((item) => new Station(item)),
                // 电影
                [PositionTypeEnum.MOVIES]: [
                    {
                        id: "1",
                        left: "64.2%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '参加考试',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "2",
                        left: "64.2%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '广告出道一鸣惊人',
                        description: `+4${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 4 } })
                    },
                    {
                        id: "3",
                        left: "64.2%",
                        top: "26.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '获得电影演出机会',
                        description: "+🎲×1000元",
                        stop: ordinaryEvents((scene) => { return { riches: scene.dicePoints * 1000 } })
                    },
                    {
                        id: "4",
                        left: "64.2%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '绯闻曝光',
                        description: `-${ICON_CONFIG.HAPPY}/2`,
                        stop: ordinaryEvents((scene) => { return { happy: ~~(-scene.curPlayer.happy / 2) } })
                    },
                    {
                        id: "5",
                        left: "68.9%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '粉丝成立后援会',
                        description: `+3${ICON_CONFIG.REPUTE}3${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 3, repute: 3 } })
                    },
                    {
                        id: "6",
                        left: "73.6%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '不实报道丑化形象',
                        description: `-${ICON_CONFIG.REPUTE}/2`,
                        stop: ordinaryEvents((scene) => { return { repute: ~~(-scene.curPlayer.repute / 2) } })
                    },
                    {
                        id: "7",
                        left: "73.6%",
                        top: "26.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '电影上映大受欢迎',
                        description: "加一千元薪级",
                        stop: ordinaryEvents((scene) => { return { salary: 1000 } })
                    },
                    {
                        id: "8",
                        left: "73.6%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成为杂志封面人物',
                        description: "+6000元",
                        stop: ordinaryEvents((scene) => { return { riches: 6000 } })
                    },
                    {
                        id: "9",
                        left: "78.4%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '荣获金马奖',
                        description: `+4${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 4, repute: 4 } })
                    },
                ].map((item) => new Station(item)),
                // 采矿
                [PositionTypeEnum.MINING]: [
                    {
                        id: "1",
                        left: "78.4%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '矿区采样',
                        description: "-2000元",
                        stop: ordinaryEvents((scene) => { return { riches: -2000 } })
                    },
                    {
                        id: "2",
                        left: "73.6%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '坑道整顿',
                        description: "再行动一次",
                        stop: ordinaryEvents((scene) => { return { actionState: PlayerActionEnum.AGAIN } })
                    },
                    {
                        id: "3",
                        left: "68.8%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '山崩',
                        description: "暂定一次",
                        stop: ordinaryEvents((scene) => { return { actionState: PlayerActionEnum.PAUSE } })
                    },
                    {
                        id: "4",
                        left: "64.1%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现黄金',
                        description: `+2${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 4, repute: 2 } })
                    },
                    {
                        id: "5",
                        left: "64.1%",
                        top: "45.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '地质分析',
                        description: "-🎲×1000元",
                        stop: ordinaryEvents((scene) => { return { riches: -scene.dicePoints * 1000 } })
                    },
                    {
                        id: "6",
                        left: "64.1%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '意外发现文明遗迹',
                        description: `+10${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 10 } })
                    },
                    {
                        id: "7",
                        left: "64.1%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '引发尘暴',
                        description: "马上移到医院",
                        stop: moveStation("LOOP", 8)
                    },
                    {
                        id: "8",
                        left: "68.8%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现石油',
                        description: "+8000元",
                        stop: ordinaryEvents((scene) => { return { riches: 8000 } })
                    },
                    {
                        id: "9",
                        left: "73.6%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '研发秘密输送管线',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "10",
                        left: "73.6%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现钻石',
                        description: "+6000元",
                        stop: ordinaryEvents((scene) => { return { riches: 6000 } })
                    },
                    {
                        id: "11",
                        left: "78.4%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成立跨国采矿集团',
                        description: "+10000元",
                        stop: ordinaryEvents((scene) => { return { riches: 10000 } })
                    },
                ].map((item) => new Station(item)),
                // 航天
                [PositionTypeEnum.SPACE]: [
                    {
                        id: "1",
                        left: "78.4%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '协助建造航天飞机',
                        description: `+6${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 6 } })
                    },
                    {
                        id: "2",
                        left: "73.6%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '成功发射航天飞机',
                        description: "抽两张经验卡"
                    },
                    {
                        id: "3",
                        left: "68.9%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '压力不适导致呕吐',
                        description: `-4${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: -4 } })
                    },
                    {
                        id: "4",
                        left: "64.2%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '通讯故障',
                        description: "-3000元",
                        stop: ordinaryEvents((scene) => { return { riches: -3000 } })
                    },
                    {
                        id: "5",
                        left: "59.5%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '紧急抢修',
                        description: `+2${ICON_CONFIG.REPUTE}4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { repute: 2, happy: 4 } })
                    },
                    {
                        id: "6",
                        left: "54.7%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '闪避陨石',
                        description: `+6${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6 } })
                    },
                    {
                        id: "7",
                        left: "54.7%",
                        top: "69%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '登陆火星',
                        description: `+🎲×${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: scene.dicePoints } })
                    },
                    {
                        id: "8",
                        left: "54.7%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现火星特有细菌',
                        description: "+4000元",
                        stop: ordinaryEvents((scene) => { return { riches: 4000 } })
                    },
                    {
                        id: "9",
                        left: "59.5%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '测量地形',
                        description: `+10${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { happy: 10 } })
                    },
                    {
                        id: "10",
                        left: "64.2%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '发现神秘文明遗迹',
                        description: `+10${ICON_CONFIG.REPUTE}`,
                        stop: ordinaryEvents((scene) => { return { repute: 10 } })
                    },
                    {
                        id: "11",
                        left: "68.9%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '航天服破裂',
                        description: "马上移动医院"
                    },
                    {
                        id: "12",
                        left: "73.6%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '返航地球',
                        description: `+6${ICON_CONFIG.REPUTE}+4${ICON_CONFIG.HAPPY}`,
                        stop: ordinaryEvents((scene) => { return { repute: 6, happy: 4 } })

                    },
                    {
                        id: "13",
                        left: "73.6%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: '将经历写成小说',
                        description: "+6000元",
                        stop: ordinaryEvents((scene) => { return { riches: 6000 } })

                    },
                ].map((item) => new Station(item)),
            }

            /**
             * 离开内圈到达外圈的位置
             */
            let exitInsidePosition = {
                // 农业
                [PositionTypeEnum.AGRICULTURE]: 5,
                // 大学
                [PositionTypeEnum.UNIVERSITY]: 10,
                // 企业
                [PositionTypeEnum.ENTERPRISE]: 12,
                // 航海
                [PositionTypeEnum.VOYAGE]: 17,
                // 公益
                [PositionTypeEnum.WELFARE]: 20,
                // 电影
                [PositionTypeEnum.MOVIES]: 25,
                // 采矿 
                [PositionTypeEnum.MOVIES]: 28,
                // 航天
                [PositionTypeEnum.SPACE]: 1
            }

            let scene = new SceneStation();


            for (const station of [...loopStations, ...Object.values(insideStations).flat()]) {
                let stationDom = createFragment(`<div class="station-item"></div>`).querySelector(".station-item")
                stationDom.style.left = station.left
                stationDom.style.top = station.top
                stationDom.style.width = station.width
                stationDom.style.height = station.height
                mapContainerDom.appendChild(stationDom)
                station.dom = stationDom
            }

            /**
             * 玩家加入
             * @param {Player[]} players
             */
            let join = async (players) => {
                scene.allPlayers = players;
                for (const player of players) {
                    let playerItemTemplate = `
                        <div class="player-item" data-id="${player.id}">
                            <div class="player-avatar" style="background-image:url(${player.avatar});border-color:${player.color}"></div>
                        </div>
                    `
                    let playerFragment = createFragment(playerItemTemplate)
                    // 起点出发
                    loopStations[0].dom.appendChild(playerFragment)
                }
            }
            /**
             * 玩家移动
             * @param {Player} player
             * @param {number} count
             */
            let move = async (player, count) => {
                // count = 6 //loopStations.length + 

                scene.curPlayer = player;
                scene.dicePoints = count;

                let currDom = mapContainerDom.querySelector(`.player-item[data-id="${player.id}"]`);
                for (let i = 0; i < count; i++) {
                    await wait(500); // 测试加速 
                    player.position++
                    player.save() // 暂存位置信息
                    let station = null
                    let insideStation = insideStations[player.positionType]
                    // 进入内圈
                    if (insideStation) {
                        console.log(insideStation, scene.prevStation);

                        if (scene.prevStation != insideStation[insideStation.length - 1]) { // 在内圈转动
                            station = insideStation[player.position]  // 内圈站点
                        }
                        else {
                            player.position = exitInsidePosition[player.positionType] // 初始化进入外圈的位置
                            player.positionType = PositionTypeEnum.LOOP // 切换外圈类型
                        }
                    }

                    // 进入外圈
                    if (player.positionType == PositionTypeEnum.LOOP) {
                        station = loopStations[player.position % loopStations.length]; // 外圈站点
                    }

                    station.dom.appendChild(currDom)
                    scene.prevStation = station; // 上一个站点
                    if (count - i > 1) await station.via‌?.(scene) // 经过
                    else await station.stop?.(scene)  // 停留 
                    lookAt(currDom.parentNode) // 镜头跟随
                }
                await wait(1000);
            }


            /**
             * 玩家离开
             * @param {Player} player
             */
            let leave = async (player) => {
                // 进入外圈
                if (player.positionType == PositionTypeEnum.LOOP) {
                    let station = loopStations[player.position % loopStations.length]; // 外圈站点
                    scene.curPlayer = player;
                    console.log(station.leave);
                    if (station.leave === undefined) return true;
                    return await station.leave(scene)
                }
                return true;
            }



            /**
             * 下一个玩家
             * @param {Player} player 
             */
            let next = async (player) => {
                let lastDom = mapContainerDom.querySelector('.player-item.active');
                let currDom = mapContainerDom.querySelector(`.player-item[data-id="${player.id}"]`);
                if (lastDom) lastDom.classList.remove('active')
                currDom.classList.add('active')
                lookAt(currDom.parentNode) // 镜头跟随
            }




            return {
                fragment,
                join,
                move,
                next,
                leave
            }
        }()


        /**
         * 初始化游戏内容
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        async function initGame() {
            let gameContainerDom = createFragment(`<div class="game-container"></div>`).querySelector('.game-container')
            gameContainerDom.appendChild(mapContainer.fragment)
            gameContainerDom.appendChild(logContainer.fragment)
            gameContainerDom.appendChild(dialogContainer.fragment)
            gameContainerDom.appendChild(diceContainer.fragment)
            gameContainerDom.appendChild(roleContainer.fragment)
            gameContainerDom.appendChild(playerContainer.fragment)
            gameContainerDom.appendChild(hospitalContainer.fragment)
            gameContainerDom.appendChild(parkContainer.fragment)
            gameContainerDom.appendChild(lotteryContainer.fragment)
            document.body.appendChild(gameContainerDom)



            // 选中的角色
            let roles = [
                {
                    "name": "小黑",
                    "avatar": "./assets/monopoly/black.jpg",
                    "color": "black",
                    "targetRiches": 60,
                    "targetRepute": 0,
                    "targetHapply": 0
                },
                {
                    "name": "小红",
                    "avatar": "./assets/monopoly/red.jpg",
                    "color": "red",
                    "targetRiches": 60,
                    "targetRepute": 0,
                    "targetHapply": 0
                }
            ]
            let players = roles.map(r => new Player(r))
            // 掷骰子
            // let diceTotal = await diceContainer.open(1)

            // 选择角色
            // let selecedRoles = await roleContainer.open()


            // 医院测试
            // let dictTotal = await hospitalContainer.open()


            // 公园测试
            // let parkTotal = await parkContainer.open()

            // 彩票测试
            // let lotteryResult = await lotteryContainer.open(players)





            // 队列
            const queue = {
                players: [], // 玩家列表
                join: function (players) {
                    this.players = players;
                    playerContainer.join(players)
                    mapContainer.join(players)
                    return this;
                },
                next: async function () {
                    /** @type {Player} */
                    let player = this.players.shift()

                    // 暂停一轮
                    if (player.actionState == PlayerActionEnum.PAUSE) {
                        player.actionState = PlayerActionEnum.NONE;
                        this.players.push(player)
                        this.next();
                        return;
                    }

                    mapContainer.next(player)
                    playerContainer.next(player)

                    // 判断当前玩家是否可以移动  例如特定场地
                    let allowMove = await mapContainer.leave(player)
                    if (allowMove) {
                        logContainer.log(`玩家[${player.name}]开始掷骰子🎲`)
                        let dictCount = player.positionType == PositionTypeEnum.LOOP ? 2 : 1; // 骰子数量
                        let dictTotal = await diceContainer.open(dictCount);
                        logContainer.log(`玩家[${player.name}]投掷数为[${dictTotal}]`)
                        await mapContainer.move(player, dictTotal)
                    }

                    // 再来一次
                    if (player.actionState === PlayerActionEnum.AGAIN) {
                        player.actionState = PlayerActionEnum.NONE;
                        this.players.unshift(player)
                    }
                    else this.players.push(player);
                    this.next()
                },
            }

            queue.join(players).next()


            // let selected = await dialogContainer.open({
            //     title: '提示',
            //     content: '请选择想要的选项',
            //     options: ["A", "B", "C"]
            // })
            // console.log(selected);


        }

        initGame();

    </script>
</body>

</html>