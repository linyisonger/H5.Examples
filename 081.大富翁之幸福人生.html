<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/global.css">


    <style>
        body {
            height: 100vh;
        }

        .flex-center {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            position: relative;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            user-select: none;
        }

        .map-container {
            position: absolute;
            left: 0;
            top: 0;
            background-size: contain;
        }

        .log-container {
            position: absolute;
            left: 0;
            bottom: 0;
            height: 50%;
            width: 500px;
            background-color: rgba(255, 255, 255, .7);
        }

        .log-container .log-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .log-container .log-body {
            margin: 0 20px 20px;
            height: calc(100% - 70px);
            overflow-y: auto;
        }

        .log-container .log-icon-close {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .log-container.close {
            bottom: calc(-50% + 50px);
        }

        .log-container.close .log-icon-close {
            transform: rotate(180deg);
        }

        .log-container .log-item-table {
            border-top: 1px solid #000;
            border-left: 1px solid #000;
            border-collapse: collapse;
        }

        .log-container .log-item-table td {
            border-right: 1px solid #000;
            border-bottom: 1px solid #000;
            text-align: center;
        }

        .dice-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background-color: rgba(255, 255, 255, .9);
        }

        .dice-container .dice-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .dice-container .dice-body {
            margin: 0 20px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dice-container .dice-item {
            width: 50px;
            height: 50px;
            background-repeat: no-repeat;
            background-size: 100%;
            margin-bottom: 20px;
        }

        .dice-container .dice-item:nth-child(n+2) {
            margin-left: 20px;
        }

        .dice-container .dice-item-container {
            display: flex;
        }

        .dice-container.close {
            top: -100%;
        }

        .dice-container .dice-item.hidden {
            display: none;
        }


        .role-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            width: 600px;
            height: 415px;
        }

        .role-container .role-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .role-container .role-body {
            margin: 0 20px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        .role-container .role-item-container {
            display: flex;
            width: 100%;
            justify-content: space-between;
        }

        .role-container .role-item {
            display: flex;
            flex: 1;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            margin: 20px 10px;
        }

        .role-container .role-item.active {
            background-color: #2776ec2f;
        }

        .role-container .role-item-name {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }

        .role-container .role-item-avatar {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            background-size: contain;
        }

        .role-container .target-item-container {
            display: flex;
            width: 100%;
            padding-bottom: 20px;
        }

        .role-container .target-item {
            display: flex;
            flex-direction: column;
            flex: 1;
            align-items: center;
        }

        .role-container .target-item input {
            width: 70px;
            outline: none;
            border-top: 0;
            border-left: 0;
            border-right: 0;
            border-width: 1px;
            border-color: #2e2e2e;
            background-color: transparent;
            margin-left: 5px;
            text-align: center;
        }

        .role-container .target-item.error input {
            border-color: #cc0000;
        }

        .role-container .target-item.valid input {
            border-color: #00cc00;
        }


        .role-container .target-item-content {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .role-container .target-hint {
            width: 100%;
            font-size: 14px;
            margin-bottom: 20px;
            margin-left: 20px;
        }



        .role-container.close {
            top: -100%;
        }


        .players-container {
            display: flex;
            position: absolute;
            top: 0px;
            right: 0;
            background-color: #ffffffcc;
        }

        .players-container .player-item {
            display: flex;
            padding: 10px 10px 10px 20px;
            width: 228px;
            height: 120px;
            align-items: center;
            box-sizing: border-box;
        }

        .players-container .player-item.active .player-avatar::after {
            position: absolute;
            background-image: url('./assets/monopoly-life/dice.png');
            background-size: 20px 20px;
            background-repeat: no-repeat;
            width: 20px;
            height: 20px;
            right: 0;
            bottom: 0;
            content: "";
        }

        .players-container .player-avatar {
            margin: 10px;
            width: 60px;
            height: 60px;
            background-size: contain;
            border-radius: 50%;
            position: relative;
        }




        .players-container .player-base-info {
            display: flex;
            flex-direction: column;
        }

        .players-container .player-base-info>div {
            display: flex;
        }

        .players-container .player-base-info>div>.player-icon {
            margin-right: 10px;
        }

        .players-container.close {
            transform: 0;
        }


        .game-btn-confirm {
            display: inline-flex;
            padding: 0 20px;
            line-height: 40px;
            background-color: #2776ec;
            color: #fff;
            cursor: pointer;
        }

        .game-btn-confirm:active {
            opacity: .7;
        }

        object {
            pointer-events: none;
        }

        .map-container.anim {
            transition: all .2s linear;
        }

        .map-container .station-item {
            position: absolute;
            border: 2px solid #00cc00;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .map-container .player-item {
            display: inline-flex;
        }

        .map-container .player-avatar {
            margin: 10px;
            width: 60px;
            height: 60px;
            background-size: contain;
            border-radius: 50%;
        }

        .map-container .player-item.active .player-avatar {
            border-width: 5px;
            border-style: solid;
        }



        .dialog-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 1);
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            width: 500px;
        }

        .dialog-container .dialog-header-title {
            line-height: 50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            margin: 0 20px;
        }

        .dialog-container .dialog-body {
            padding-top: 20px;
            margin: 0 20px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
    </style>
</head>

<body>
    <script type="module">

        import { Maths } from "https://gcore.jsdelivr.net/npm/@3r/tool/lib/maths.js";
        import { Randoms } from "https://gcore.jsdelivr.net/npm/@3r/tool/lib/randoms.js";
        /** 
         * è·å–æ•°å­—
         * @param {string} str 
         */
        function getNumber(str) {
            return +str.match(/[-\d]{0,}/)[0]
        }

        /**
         * åŠ è½½å›¾
         * @param {string} src
         * @returns {Promise<HTMLImageElement>}
         */
        function loadImage(src) {
            return new Promise((resolve) => {
                let image = new Image()
                image.src = src;
                image.onload = (ev) => {
                    resolve(image)
                }
            })
        }

        /** 
         * æ‹–æ‹½å…ƒç´ 
         * @param {HTMLImageElement} dom
         * @param {{minX:number,maxX:number,minY:number,maxY:number}} options
         */
        function dragging(dom, options) {
            // å¼€å§‹åæ ‡ä½ç½®
            let startX = 0;
            let startY = 0;
            let startLeft = 0;
            let startTop = 0;
            let isMove = false;

            dom.classList.add('anim')

            dom.addEventListener("mousedown", ev => {
                // ç§»é™¤åŠ¨ç”»æ ‡ç­¾
                dom.classList.remove('anim')

                startX = ev.x;
                startY = ev.y;
                startLeft = getNumber(dom.style.left);
                startTop = getNumber(dom.style.top);
                isMove = true;
            })

            dom.addEventListener("mousemove", ev => {
                if (!isMove) return;
                let left = startLeft + ev.x - startX;
                let top = startTop + ev.y - startY;
                left = Maths.inRange(left, options.minX, options.maxX)
                top = Maths.inRange(top, options.minY, options.maxY)
                dom.style.left = left + 'px';
                dom.style.top = top + 'px';
            })

            dom.addEventListener("mouseup", ev => {
                // å¢åŠ åŠ¨ç”»æ ‡ç­¾
                dom.classList.add('anim')
                isMove = false;
            })

            let screenWidth = document.body.clientWidth
            let screenHeight = document.body.clientHeight

            /**
             * @param {HTMLDivElement} target
             */
            const lookAt = async function (target) {
                // let left = - (target.offsetLeft + target.offsetWidth / 2 - screenWidth / 2)
                // let top = - (target.offsetTop + target.offsetHeight / 2 - screenHeight / 2)
                // left = Maths.inRange(left, options.minX, options.maxX)
                // top = Maths.inRange(top, options.minY, options.maxY)
                // dom.style.left = left + 'px';
                // dom.style.top = top + 'px';
            }

            return {
                lookAt
            }
        }

        /** 
         * ç­‰å¾…å¤šä¹… 
         */
        function wait(ms) {
            return new Promise((resolve) => {
                setTimeout(resolve, ms)
            })
        }

        /**
         * åˆ›å»ºå®¹å™¨
         * @param {string} html 
         */
        function createFragment(html) {
            const fragment = document.createDocumentFragment();
            const div = document.createElement("div");
            div.innerHTML = html;
            fragment.appendChild(div.children.item(0))
            return fragment;
        }

        /** ä½ç½®ç±»å‹æšä¸¾ */
        const PositionTypeEnum = {
            /** ç¯é“ */
            LOOP: 1,
            /** å†œä¸š */
            AGRICULTURE: 2,
            /** å¤§å­¦ */
            UNIVERSITY: 3,
            /** ä¼ä¸š */
            ENTERPRISE: 4,
            /** èˆªè¡Œ */
            VOYAGE: 5,
            /** å…¬ç›Š */
            WELFARE: 6,
            /** å½±è§† */
            MOVIES: 7,
            /** é‡‡çŸ¿ */
            MINING: 8,
            /** å¤ªç©º */
            SPACE: 9
        }

        /** å›¾ç‰‡é…ç½® */
        const ICON_CONFIG = {
            RICHES: `<img src="./assets/monopoly-life/riches.png" />`,
            SALARY: `<img src="./assets/monopoly-life/salary.png" />`,
            REPUTE: `<img src="./assets/monopoly-life/repute.png" />`,
            HAPPY: `<img src="./assets/monopoly-life/happy.png" /> `,
            ARROW: `<img src="./assets/monopoly-life/arrow.png" />`
        }

        class Role {
            id = Randoms.uuid()
            name = ''
            avatar = ''
            color = ''
            targetRiches = 0
            targetRepute = 0;
            targetHapply = 0
            /**
             * @param {Role} role
             */
            constructor(role) {
                for (const key in role) {
                    this[key] = role[key]
                }
            }
        }

        class Player extends Role {
            /** è´¢å¯Œ */
            riches = 5000
            /** è–ªæ°´ */
            salary = 2000
            /** å£°æœ› */
            repute = 0;
            /** å¹¸ç¦ */
            happy = 0;

            /** ä½ç½® */
            position = 0;
            /** ä½ç½®ç±»å‹ */
            positionType = 0
            /** å†å²è®°å½• */
            history = []

            /**
             * @param {Player} player
             */
            constructor(player) {
                super(player)
                for (const key in player) {
                    this[key] = player[key]
                }

                this.save = function () {
                    this.history.push({
                        position: this.position,
                        positionType: this.positionType
                    })
                }
            }


        }

        class SceneStation {
            /** @type {Player} */
            curPlayer = null
            /** @type {Player[]} */
            allPlayers = []
            dicePoints = 0
        }

        class Station {
            /** @type {string} */
            id = ""
            /** @type {string} */
            left = ""
            /** @type {string} */
            top = ""
            /** @type {string} */
            width = ""
            /** @type {string} */
            height = ""
            /** @type {string} */
            name = ""
            /** @type {string} */
            description = ""
            /** @type {HTMLDivElement} */
            dom = null
            /**
             * ç»è¿‡
             * @param {SceneStation} scene
             */
            viaâ€Œ = (scene) => { }
            /**
             * åœæ­¢
             * @param {SceneStation} scene
             */
            stop = (scene) => { }


            /**
             * @param {Station} station
             */
            constructor(station) {
                for (const key in station) {
                    this[key] = station[key]
                }
            }
        }


        /**
         * æ—¥å¿—æ§ä»¶ å·¦ä¸‹è§’
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const logContainer = function () {
            const template = `
                <div class="log-container">
                    <div class="log-header">
                        <div class="log-header-title">
                            æ¸¸æˆæ—¥å¿—
                        </div>
                        <div class="log-icon-close">
                            ${ICON_CONFIG.ARROW}
                        </div>
                    </div>
                    <div class="log-body">
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const logContainerDom = fragment.querySelector('.log-container')
            const closeDom = logContainerDom.querySelector('.log-icon-close')
            const logContainerBodyDom = logContainerDom.querySelector('.log-body')

            closeDom.addEventListener('click', () => {
                console.log('ç‚¹å‡»å…³é—­æŒ‰é’®');
                logContainerDom.classList.toggle('close')
            })

            /**
             * @param {string} str
             */
            const log = (str) => {
                let dom = createFragment(`<div class="log-item">${str}</div>`).querySelector('.log-item')
                logContainerBodyDom.appendChild(dom)
                logContainerBodyDom.scrollTop = Number.MAX_SAFE_INTEGER;
            }
            log("æ—¥å¿—æ¡†åˆå§‹åŒ–å®Œæˆ")

            return {
                fragment,
                log
            }
        }();


        /**
         * ç©å®¶æ§ä»¶ å³ä¸Šè§’
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const playerContainer = function () {
            const template = `
                <div class="players-container close"></div>
            `
            const fragment = createFragment(template)
            const playerContainerDom = fragment.querySelector('.players-container')
            /**
             * @param {Player[]} players
             */
            let join = async (players) => {
                for (const player of players) {
                    let playerItemTemplate = `
                        <div class="player-item" data-id="${player.id}">
                            <div class="player-avatar" style="background-image:url(${player.avatar})"></div>
                            <div class="player-base-info">
                                <div class="player-riches">
                                    <div class="player-icon">
                                         ${ICON_CONFIG.RICHES}
                                    </div>
                                    <div class="player-value">${player.riches}</div>
                                </div>
                                <div class="player-salary">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.SALARY}
                                    </div>
                                    <div class="player-value">${player.salary}</div>
                                </div>
                                <div class="player-repute">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.REPUTE}  
                                    </div>
                                    <div class="player-value">${player.repute}</div>
                                </div>
                                <div class="player-happy">
                                    <div class="player-icon">
                                        ${ICON_CONFIG.HAPPY}
                                    </div>
                                    <div class="player-value">${player.happy}</div>
                                </div>
                            </div>
                        </div>
                    `
                    let playerFragment = createFragment(playerItemTemplate)
                    playerContainerDom.appendChild(playerFragment)
                }
                playerContainerDom.classList.remove('close')
            }


            /**
             * @param {Player[]} players
             */
            let upd = async (players) => {
                for (const player of players) {
                    let dom = playerContainerDom.querySelector(`.player-item[data-id="${player.id}"]`)
                    dom.querySelector('.player-riches .player-value').textContent = player.riches
                    dom.querySelector('.player-salary .player-value').textContent = player.salary
                    dom.querySelector('.player-repute .player-value').textContent = player.repute
                    dom.querySelector('.player-happy .player-value').textContent = player.happy
                }
            }

            /**
             * @param {Player} player
             */
            let next = async (player) => {
                let lastDom = playerContainerDom.querySelector('.player-item.active');
                let currDom = playerContainerDom.querySelector(`.player-item[data-id="${player.id}"]`);
                if (lastDom) lastDom.classList.remove('active')
                currDom.classList.add('active')
            }

            logContainer.log('ç©å®¶æ§ä»¶åˆå§‹åŒ–å®Œæˆ')
            return {
                fragment,
                join,
                upd,
                next
            }
        }();

        /**
         * éª°å­æ§ä»¶ å¼¹çª—
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const diceContainer = await async function () {

            const template = `
                <div class="dice-container close">
                    <div class="dice-header">
                        <div class="dice-header-title">
                            æ·éª°å­
                        </div>
                    </div>
                    <div class="dice-body">
                        <div class="dice-item-container">
                            <div class="dice-item"></div>
                            <div class="dice-item"></div>
                        </div>
                        <div class="game-btn-confirm">å¼€å§‹è½¬åŠ¨</div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const diceImages = await Promise.all([
                './assets/monopoly/1.png',
                './assets/monopoly/2.png',
                './assets/monopoly/3.png',
                './assets/monopoly/4.png',
                './assets/monopoly/5.png',
                './assets/monopoly/6.png',
            ].map(u => loadImage(u)))
            /** @type {HTMLDivElement} */
            const diceContainerDom = fragment.querySelector('.dice-container')
            /** @type {HTMLDivElement} */
            const diceItemContainerDom = fragment.querySelector('.dice-item-container')
            /** @type {HTMLDivElement} */
            const confirmDom = diceContainerDom.querySelector('.game-btn-confirm')
            /** 
             * å›è°ƒå‡½æ•°
             * @param {number} total
             */
            let cb = (total) => { }

            confirmDom.addEventListener("click", async () => {
                // æ‰§è¡ŒğŸ²
                const diceItemDomList = diceItemContainerDom.querySelectorAll('.dice-item:not(.hidden)')
                // ç»“æœ
                const result = {}
                // å¾ªç¯15æ¬¡çº¦ç­‰äº1.5s
                for (let i = 0; i < 15; i++) {
                    await wait(100);
                    for (let j = 0; j < diceItemDomList.length; j++) {
                        /** @type {HTMLDivElement} */
                        const diceItemDom = diceItemDomList.item(j);
                        const val = Randoms.int(0, 6)
                        diceItemDom.style.backgroundImage = `url(${diceImages[val].src})`
                        result[j] = val + 1
                    }
                }
                const total = Maths.sum(Object.values(result))
                cb?.(total)


            })
            /**
             * @param {number} count
             * @param {(total: number) => void} callback
             */
            const open = (count, callback) => {
                cb = callback
                for (let i = 0; i < diceItemContainerDom.children.length; i++) {
                    const dom = diceItemContainerDom.children.item(i)
                    dom.classList.add('hidden')
                }
                for (let i = 0; i < count; i++) {
                    /** @type {HTMLDivElement} */
                    const dom = diceItemContainerDom.children.item(i)
                    dom.classList.remove('hidden')
                    dom.style.backgroundImage = `url(${diceImages[0].src})`
                }
                diceContainerDom.classList.remove('close')
            }
            logContainer.log("éª°å­æ§ä»¶åŠ è½½å®Œæˆ")

            const close = () => {
                diceContainerDom.classList.add('close')
            }

            return {
                fragment,
                open,
                close
            }
        }()


        /**
         * è§’è‰²æ§ä»¶ å¼¹çª—
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const roleContainer = await async function () {
            const roleList = [
                new Role({
                    name: 'å°é»‘',
                    avatar: './assets/monopoly/black.jpg',
                    color: 'black'
                }),
                new Role({
                    name: 'å°çº¢',
                    avatar: './assets/monopoly/red.jpg',
                    color: 'red'
                }),
                new Role({
                    name: 'å°é»„',
                    avatar: './assets/monopoly/yellow.jpg',
                    color: 'yellow'
                }),
                new Role({
                    name: 'å°è“',
                    avatar: './assets/monopoly/blue.jpg',
                    color: 'blue'
                })
            ]
            await Promise.all(roleList.map(r => loadImage(r.avatar)))
            let roleItemHtml = ``
            let targetItemHtml = ``
            for (let i = 0; i < roleList.length; i++) {
                const role = roleList[i];
                roleItemHtml += `
                    <div class="role-item active">
                        <div class="role-item-avatar" style="background-image:url(${role.avatar})"></div>
                        <div class="role-item-name">${role.name}</div>
                    </div> 
                `

                targetItemHtml += `
                    <div class="target-item">
                        <div class="target-item-content">
                            ${ICON_CONFIG.RICHES}
                            <input type="number" placeholder="è´¢å¯Œ" max="60" min="0" step="1"/>
                        </div>
                        <div class="target-item-content">
                            ${ICON_CONFIG.REPUTE}  
                            <input type="number" placeholder="åèª‰" max="60" min="0" step="1"/>
                        </div>
                        <div class="target-item-content">
                            ${ICON_CONFIG.HAPPY}
                            <input type="number" placeholder="å¿«ä¹" max="60" min="0" step="1"/>
                        </div>
                    </div>
                `
            }

            const template = `
                <div class="role-container close">
                    <div class="role-header">
                        <div class="role-header-title">
                            è§’è‰²é€‰æ‹©
                        </div>
                    </div>
                    <div class="role-body">
                        <div class="role-item-container">
                            ${roleItemHtml}
                        </div>
                        <div class="target-item-container">
                            ${targetItemHtml}
                        </div>
                        <div class="target-hint">
                            è¾“å…¥è´¢å¯Œã€åèª‰ã€å¿«ä¹çš„é¢„å®šç›®æ ‡ï¼Œè´¢å¯Œ1000å…ƒä¸º1åˆ†ï¼Œä¸‰é¡¹ç›®æ ‡åŠ èµ·æ¥å¿…é¡»åˆšå¥½60åˆ†ã€‚
                        </div>
                        <div class="game-btn-confirm">ç¡®è®¤é€‰æ‹©</div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const roleContainerDom = fragment.querySelector('.role-container')
            const roleItemContainerDom = roleContainerDom.querySelector('.role-item-container')
            const targetItemContainerDom = roleContainerDom.querySelector('.target-item-container')
            roleItemContainerDom.querySelectorAll('.role-item').forEach((dom) => {
                dom.addEventListener('click', function () {
                    if (dom.classList.contains('active')) {
                        if (roleItemContainerDom.querySelectorAll('.role-item.active').length < 3) return
                        dom.classList.remove('active')
                    }
                    else {
                        dom.classList.add('active')
                    }
                })
            })

            /** @type {HTMLDivElement} */
            const confirmDom = roleContainerDom.querySelector('.game-btn-confirm')
            let cb = (roles) => { }
            confirmDom.addEventListener("click", () => {
                console.log('é€‰ä¸­è§’è‰²');
                let selected = []
                let roles = roleItemContainerDom.querySelectorAll('.role-item')
                let targets = targetItemContainerDom.querySelectorAll('.target-item')
                let valid = true
                roles.forEach((role, roleIndex) => {
                    let target = targets.item(roleIndex)
                    target.classList.remove('error')
                    target.classList.remove('valid')
                    if (role.classList.contains('active')) {
                        let inputs = target.querySelectorAll('input')
                        let targetRiches = +inputs.item(0).value
                        let targetRepute = +inputs.item(1).value
                        let targetHapply = +inputs.item(2).value
                        selected.push(new Role({
                            ...roleList[roleIndex],
                            targetRiches,
                            targetRepute,
                            targetHapply
                        }))
                        if (targetRiches + targetRepute + targetHapply != 60) {
                            target.classList.add('error')
                            valid = false;
                        }
                        else {
                            target.classList.add('valid')
                            valid = true
                        }
                    }
                })

                if (valid) {
                    cb?.(selected);
                }

            })
            logContainer.log('è§’è‰²æ§ä»¶åŠ è½½å®Œæˆ')
            /**
             * @param {(roles:[])=>{}} callback
             */
            const open = (callback) => {
                cb = callback
                roleContainerDom.classList.remove('close')
            }
            return {
                fragment,
                open
            }
        }()


        /**
         * æˆ˜æ–—æ§ä»¶
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const fightContainer = await async function () {


            const open = () => {
                // p1 vs p2

                // æ·éª°å­

                // ç»“æœ
            }

            return {
                open
            }
        }()


        /**
         * è·å–æœºä¼š[ç»éªŒ]å¡æ§ä»¶
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const chanceContainer = await async function () {

        }()


        /**
         * å¡åŒ…æ§ä»¶
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const cardHolderContainer = await async function () {
            const open = function () {

            }

            return {
                open
            }

        }()



        /**
         * å¯¹è¯æ¡†æ§ä»¶
         * @author 	 linyisonger
         * @date 	 2024-12-03
         */
        const dialogContainer = function () {
            const template = `
                <div class="dialog-container">
                    <div class="dialog-header">
                        <div class="dialog-header-title">
                            å¯¹è¯æ¡†
                        </div>
                    </div>
                    <div class="dialog-body">
                        <div class="dialog-body-content">
                            è¯·é€‰æ‹©ä½ æƒ³è¦çš„é€‰é¡¹
                        </div>
                        <div class="dialog-body-options">
                            <div class="dialog-body-option">
                                A
                            </div>
                            <div class="dialog-body-option">
                                B
                            </div>
                            <div class="dialog-body-option">
                                C
                            </div>
                        </div>
                    </div>
                </div>
            `
            const fragment = createFragment(template)
            const dialogContainerDom = fragment.querySelector('.dialog-container')
            class DialogOpenConfig {
                title = ''
                content = ''
                options = []
            }

            /**
             * æ‰“å¼€å¼¹çª—
             * @param {DialogOpenConfig} config
             */
            const open = function (config) {
                return new Promise((resolve) => {
                    const titleDom = dialogContainerDom.querySelector('.dialog-header-title')
                    const contentDom = dialogContainerDom.querySelector('.dialog-body-content')
                    const optionsDom = dialogContainerDom.querySelector('.dialog-body-options')
                    titleDom.textContent = config.title;
                    contentDom.innerHTML = config.content
                    optionsDom.innerHTML = '';
                    for (let i = 0; i < config.options.length; i++) {
                        const option = config.options[i];
                        const optionDom = document.createElement('div')
                        optionDom.classList.add('dialog-body-option')
                        optionDom.innerHTML = option
                        optionDom.addEventListener("click", function () {
                            resolve(i)
                        })
                        optionsDom.appendChild(optionDom)
                    }
                })

            }

            return {
                fragment,
                open
            }
        }()

        /**
         * åœ°å›¾æ§ä»¶
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        const mapContainer = await async function () {
            let template = `
                <div class="map-container"></div>
            `;
            let fragment = createFragment(template)

            /** @type {HTMLDivElement} */
            let mapContainerDom = fragment.querySelector('.map-container')
            let screenWidth = document.body.clientWidth
            let screenHeight = document.body.clientHeight
            console.log(screenHeight);
            // åŠ è½½å›¾ç‰‡èƒŒæ™¯
            let mapImage = await loadImage('./assets/monopoly-life/map.jpg')
            mapContainerDom.style.backgroundImage = `url(${mapImage.src})`
            mapContainerDom.style.width = mapImage.width / 2 + 'px'
            mapContainerDom.style.height = mapImage.height / 2 + 'px'
            // æº¢å‡ºè·ç¦»
            let overflowDistance = 100
            let { lookAt } = dragging(mapContainerDom, { minX: -mapImage.width / 2 + screenWidth - overflowDistance, maxX: 0 + overflowDistance, minY: -mapImage.height / 2 + screenHeight - overflowDistance, maxY: 0 + overflowDistance })
            logContainer.log("åŠ è½½åœ°å›¾èƒŒæ™¯å®Œæˆ")


            class PlayerChanged {
                /** è´¢å¯Œ */
                riches = 0
                /** è–ªæ°´ */
                salary = 0
                /** å£°æœ› */
                repute = 0
                /** å¹¸ç¦ */
                happy = 0
            }

            class EmploymentEntranceCondition {
                /** è´¢å¯Œ */
                riches = 0
            }

            /**
             * æ•°å€¼å˜åŒ–
             * @param {Player} player
             * @param {PlayerChanged} changed
             */
            function playerChange(player, changed) {
                if (Maths.sum(Object.values(changed)) == 0) {
                    logContainer.log(`ç©å®¶[${player.name}]æ²¡æœ‰ä»»ä½•å˜åŒ–`)
                    return
                }; // æ²¡æœ‰å‘ç”Ÿæ”¹å˜
                let str = `<div class="flex-center">ç©å®¶[${player.name}]`
                if (changed.riches) {
                    str += `${ICON_CONFIG.RICHES}`
                    if (changed.riches > 0) str += `<span style="color:red">+${changed.riches}å…ƒ</span>`
                    else str += `<span style="color:green">${changed.riches}å…ƒ</span>`
                    player.riches += changed.riches
                }
                str += '</div>'
                logContainer.log(str)
                playerContainer.upd([player])
            }

            /**
             * è¡¨æ ¼å±•ç¤º
             * @param {SceneStation} scene 
             */
            function table(scene) {
                // æ˜¯å¦çº¯æ–‡æœ¬
                let isText = !/<.*?>/.test(this.description);
                let description = this.description;
                if (isText) description = `<tr><td>${description}</td></tr>`
                const table = `
                    <table class="log-item-table">
                        <tbody>
                            <tr>
                                <td colspan="${isText ? 1 : 2}">${this.name}</td>
                            </tr>
                            ${description}
                        </tbody>
                    </table>
                `
                logContainer.log(`ç©å®¶[${scene.curPlayer.name}]è§¦å‘äº‹ä»¶${table}`)
            }

            /**
             * é¢†å–å·¥èµ„
             * @param {SceneStation} scene 
             */
            function salaryCollection(scene) {
                table.call(this, scene)
                playerChange(scene.curPlayer, { riches: scene.curPlayer.salary })
            }

            /**
             * ä»˜æ‰€å¾—ç¨
             * @param {SceneStation} scene 
             */
            function payIncomeTax(scene) {
                table.call(this, scene)
                for (const player of [scene.curPlayer, ...scene.allPlayers]) {
                    let tax = 0
                    if (player.salary < 3000) tax = -150;
                    if (player.salary >= 4000 && player.salary <= 6000) tax = -1500
                    if (player.salary > 6000) tax = -3000;
                    playerChange(player, { riches: tax })
                }
            }

            /**
             * ä»˜å¨±ä¹ç¨
             * @param {SceneStation} scene 
             */
            function payEntertainmentTax(scene) {
                table.call(this, scene)
                for (const player of [scene.curPlayer, ...scene.allPlayers]) {
                    let tax = 0
                    if (player.happy > 20) tax = -1000;
                    else if (player.happy > 5) tax = -2000;
                    else if (player.happy > 1) tax = -3000;
                    playerChange(player, { riches: tax })
                }
            }

            /**
            * å°±ä¸šå…¥å£
            * @param {SceneStation} scene 
            */
            function employmentEntrance(params) {
                table.call(this, scene)

            }




            /**
             * å¤–åœˆ
             * @type {Station[]}
             * @author 	 linyisonger
             * @date 	 2024-12-02
             */
            let loopStations = [
                {
                    id: "1",
                    left: "83.3%",
                    top: "83.3%",
                    width: "15.34%",
                    height: "15.34%",
                    name: 'å‘è–ªæ—¥',
                    description: "ç»è¿‡æˆ–è€…åœç•™æ­¤å¤„ï¼Œå¯é¢†å–ä¸å½“å‰è–ªçº§ç›¸å½“çš„è–ªæ°´",
                    viaâ€Œ: salaryCollection,
                    stop: salaryCollection
                },
                {
                    id: "2",
                    left: "73.7%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "3",
                    left: "64.1%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'æ‰€æœ‰äººä»˜æ‰€å¾—ç¨',
                    description: ` 
                        <tr>
                            <td>è–ªçº§</td>
                            <td>éœ€ä»˜ç¨æ¬¾</td>
                        </tr>
                        <tr>
                            <td>3åƒä»¥ä¸‹</td>
                            <td>200å…ƒ</td>
                        </tr>
                        <tr>
                            <td>4åƒåˆ°6åƒ</td>
                            <td>1500å…ƒ</td>
                        </tr>
                        <tr>
                            <td>6åƒå…ƒä»¥ä¸Š</td>
                            <td>3000å…ƒ</td>
                        </tr>
                    `,
                    stop: payIncomeTax
                },
                {
                    id: "4",
                    left: "54.6%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "5",
                    left: "45.1%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'å†œä¸šå¼€è’å°±ä¸šå…¥å£',
                    description: "å°±ä¸šæ¡ä»¶ï¼šä»˜500å…ƒåŠ¡å†œèµ„æœ¬æˆ–å·²æœ‰å†œä¸šç»éªŒ",
                    stop: employmentEntrance
                },
                {
                    id: "6",
                    left: "35.5%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "7",
                    left: "26%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'è´­ä¹°å½©ç¥¨',
                    description: ""
                },
                {
                    id: "8",
                    left: "16.4%",
                    top: "83.3%",
                    width: "9.5%",
                    height: "15.34%",
                    name: 'å¤§å­¦è¿›ä¿®å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "9",
                    left: "1%",
                    top: "83.3%",
                    width: "15.34%",
                    height: "15.34%",
                    name: 'åŒ»é™¢',
                    description: ""
                },
                {
                    id: "10",
                    left: "1%",
                    top: "73.6%",
                    width: "15.34%",
                    height: "9.5%",
                    name: 'æ‰€æœ‰äººä»˜å¨±ä¹è´¹',
                    description: `
                        <tr>
                            <td><div class="flex-center">æ‰€æŒæœ‰${ICON_CONFIG.HAPPY}</div></td>
                            <td>éœ€ä»˜æ¬¾</td>
                        </tr>
                        <tr>
                            <td><div class="flex-center">1~5${ICON_CONFIG.HAPPY}</div></td>
                            <td>3000å…ƒ</td>
                        </tr>
                        <tr>
                            <td><div class="flex-center">6~20${ICON_CONFIG.HAPPY}</div></td>
                            <td>2000å…ƒ</td>
                        </tr>
                        <tr>
                            <td><div class="flex-center">21${ICON_CONFIG.HAPPY}ä»¥ä¸Š</div></td>
                            <td>1000å…ƒ</td>
                        </tr>
                    `,
                    stop: payEntertainmentTax
                },
                {
                    id: "11",
                    left: "1%",
                    top: "64%",
                    width: "15.34%",
                    height: "9.5%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "12",
                    left: "1%",
                    top: "54.7%",
                    width: "15.34%",
                    height: "9.2%",
                    name: 'ä¼ä¸šç»è¥å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "13",
                    left: "1%",
                    top: "45.2%",
                    width: "15.34%",
                    height: "9.4%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "14",
                    left: "1%",
                    top: "35.6%",
                    width: "15.34%",
                    height: "9.5%",
                    name: 'ç”»å»Š',
                    description: ""
                },
                {
                    id: "15",
                    left: "1%",
                    top: "26.2%",
                    width: "15.34%",
                    height: "9.4%",
                    name: 'èˆªæµ·å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "16",
                    left: "1%",
                    top: "16.6%",
                    width: "15.34%",
                    height: "9.4%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "17",
                    left: "1%",
                    top: "1.2%",
                    width: "15.34%",
                    height: "15.34%",
                    name: 'ä¸‰äºšåº¦å‡',
                    description: ""
                },
                {
                    id: "18",
                    left: "16.5%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "19",
                    left: "26%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'æ±½è½¦å±•é”€ä¼š',
                    description: ""
                },
                {
                    id: "20",
                    left: "35.5%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'å…¬ç›Šäº‹ä¸šå°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "21",
                    left: "45%",
                    top: "1.2%",
                    width: "9.6%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "22",
                    left: "54.7%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'å•†åœº',
                    description: ""
                },
                {
                    id: "23",
                    left: "64.2%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'ç”µå½±æ‹æ‘„å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "24",
                    left: "73.7%",
                    top: "1.2%",
                    width: "9.4%",
                    height: "15.34%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "25",
                    left: "83.2%",
                    top: "1.2%",
                    width: "15.44%",
                    height: "15.34%",
                    name: 'å…¬å›­æ¿å‡³',
                    description: ""
                },
                {
                    id: "26",
                    left: "83.2%",
                    top: "16.6%",
                    width: "15.44%",
                    height: "9.5%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "27",
                    left: "83.2%",
                    top: "26.2%",
                    width: "15.44%",
                    height: "9.5%",
                    name: 'è‚¡ç¥¨å¸‚åœº',
                    description: ""
                },
                {
                    id: "28",
                    left: "83.2%",
                    top: "35.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: 'é‡‡çŸ¿å¼€å‘å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "29",
                    left: "83.2%",
                    top: "45.3%",
                    width: "15.44%",
                    height: "9.4%",
                    name: 'æœºä¼š',
                    description: ""
                },
                {
                    id: "30",
                    left: "83.2%",
                    top: "54.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: 'è®¸æ„¿äº•',
                    description: ""
                },
                {
                    id: "31",
                    left: "83.2%",
                    top: "64.3%",
                    width: "15.44%",
                    height: "9.4%",
                    name: 'å¤ªç©ºæ¢é™©å°±ä¸šå…¥å£',
                    description: ""
                },
                {
                    id: "32",
                    left: "83.2%",
                    top: "73.8%",
                    width: "15.44%",
                    height: "9.4%",
                    name: 'è·è¯ºè´å°”å¥–',
                    description: ""
                }
            ].map((item) => new Station(item))

            /**
             * å†…åœˆ
             * @type {{ [x: number]: Station[];}}
             * @author 	 linyisonger
             * @date 	 2024-11-30
             */
            let insideStations = {
                // å†œä¸š
                [PositionTypeEnum.AGRICULTURE]: [
                    {
                        id: "1",
                        left: "45.1%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'åœŸåœ°è‚¥æ²ƒé€‚åˆè€•ç§',
                        description: "+2â™¥",
                    },
                    {
                        id: "2",
                        left: "45.1%",
                        top: "73.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç ”å‘æ–°ç§æ”¹è‰¯ä½œç‰©',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "3",
                        left: "45.1%",
                        top: "69.01%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘å±•ç¯ä¿å†œä¸š',
                        description: "+5â™¥"
                    },
                    {
                        id: "4",
                        left: "45.1%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¤å­£æ”¶æˆ',
                        description: "+ğŸ²Ã—1000å…ƒ"
                    },
                    {
                        id: "5",
                        left: "40.4%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æœ‰æœºé¥²æ–™å®¶ç•œå¥åº·',
                        description: "+2ğŸ–4â™¥"
                    },
                    {
                        id: "6",
                        left: "35.6%",
                        top: "64.31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç”Ÿå®¶ç•œä¼ æŸ“ç—…',
                        description: "-3000å…ƒ"
                    },
                    {
                        id: "7",
                        left: "35.6%",
                        top: "69.11%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç§‹å­£å¤§ä¸°æ”¶',
                        description: "+5000å…ƒ"
                    },
                    {
                        id: "8",
                        left: "35.6%",
                        top: "73.86%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¤§é›ªå¯¼è‡´å®¶ç¦½å†»æ­»',
                        description: "-â™¥/2"
                    },
                    {
                        id: "9",
                        left: "35.6%",
                        top: "78.56%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆç«‹ç”ŸæŠ€å®éªŒå®¤',
                        description: "åŠ ä¸€åƒå…ƒè–ªçº§åˆ«"
                    }
                ].map((item) => new Station(item)),
                // å¤§å­¦
                [PositionTypeEnum.UNIVERSITY]: [
                    {
                        id: "1",
                        left: "21.2%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç»“è¯†åŒå­¦',
                        description: "+4â™¥"
                    },
                    {
                        id: "2",
                        left: "21.2%",
                        top: "73.65%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æœŸä¸­è€ƒç¡è¿‡å¤´',
                        description: "æš‚åœä¸€æ¬¡"
                    },
                    {
                        id: "3",
                        left: "26.0%",
                        top: "73.65%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ä»£è¡¨å­¦æ ¡å‚åŠ æ¯”èµ›',
                        description: "+2ğŸ–"
                    },
                    {
                        id: "4",
                        left: "26.0%",
                        top: "68.85%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'äº¤é”™æŠ¥å‘Š',
                        description: "-ğŸ²Ã—â™¥"
                    },
                    {
                        id: "5",
                        left: "26.0%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆç»©ä¼˜å¼‚è·å¥–å­¦é‡‘',
                        description: "+1000å…ƒ"
                    },
                    {
                        id: "6",
                        left: "21.2%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è·é€‰ä¸ºå­¦ç”Ÿä¼šé•¿',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "7",
                        left: "16.5%",
                        top: "64.15%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ¯•ä¸šæ—…è¡Œ',
                        description: "æŠ½ä¸¤å¼ æœºä¼šå¡"
                    },
                ].map((item) => new Station(item)),
                // ä¼ä¸š
                [PositionTypeEnum.ENTERPRISE]: [
                    {
                        id: "1",
                        left: "16.5%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é€šè¿‡å®ä¹ ',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "2",
                        left: "21.2%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç®€æŠ¥ä¼˜å¼‚',
                        description: "+4â™¥"
                    },
                    {
                        id: "3",
                        left: "26%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å…¨å‹¤å¥–é‡‘',
                        description: "+3000å…ƒ"
                    },
                    {
                        id: "4",
                        left: "30.8%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è¯¯ä¼šå®¢æˆ·å¤±å»åˆçº¦',
                        description: "æš‚åœä¸€æ¬¡"
                    },
                    {
                        id: "5",
                        left: "30.8%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç ”å‘æ–°å“å¤‡å—ç©ç›®',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "6",
                        left: "30.8%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆåŠŸæ‰©å±•ç½‘åº—å•†åœº',
                        description: "+8000å…ƒ"
                    },
                    {
                        id: "7",
                        left: "30.8%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æŠ•èµ„å‡†ç¡®',
                        description: "+4000å…ƒ"
                    },
                    {
                        id: "8",
                        left: "26.1%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è¡¨ç°çªå‡ºæ‹…ä»»ç»ç†',
                        description: "+2ğŸ–4â™¥"
                    },
                    {
                        id: "9",
                        left: "21.4%",
                        top: "40.4%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é‡‘èé£æš´å‘¨è½¬å¤±çµ',
                        description: "é©¬ä¸Šç§»åˆ°å…¬å›­"
                    },
                    {
                        id: "10",
                        left: "21.4%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å“ç®¡ä¸å‘¨å®¢æˆ·é€€è´§',
                        description: "-å…ƒ/2"
                    },
                    {
                        id: "11",
                        left: "16.55%",
                        top: "45.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¹´ç»ˆå¥–é‡‘',
                        description: "+6000å…ƒ"
                    },
                ].map((item) => new Station(item)),
                // èˆªæµ·
                [PositionTypeEnum.VOYAGE]: [
                    {
                        id: "1",
                        left: "16.5%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ä¸¥é‡æ™•èˆ¹',
                        description: "é©¬ä¸Šç§»åˆ°åŒ»é™¢"
                    },
                    {
                        id: "2",
                        left: "21.25%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ä¸æµ·è±šä¸€åŒç©ä¹',
                        description: "+2â™¥"
                    },
                    {
                        id: "3",
                        left: "26%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°ç¥ç§˜æµ·å²›',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "4",
                        left: "30.7%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é­é‡æš´é£é›¨',
                        description: "-ğŸ²Ã—â™¥"
                    },
                    {
                        id: "5",
                        left: "30.8%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‡»é€€æµ·ç›—æ•‘å›åŒä¼´',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "6",
                        left: "30.8%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è£å‡å¤§å‰¯',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "7",
                        left: "26%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ‰“ææ·±æµ·å®è—',
                        description: "+ğŸ²Ã—1000å…ƒ"
                    },
                    {
                        id: "8",
                        left: "21.3%",
                        top: "21.45%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é›¾ä¸­è¿·èˆªé¡ºåˆ©è„±é™©',
                        description: "+2ğŸ–4â™¥"
                    },
                    {
                        id: "9",
                        left: "21.3%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¹³å®‰è¿”ä¹¡',
                        description: "åŠ ä¸€åƒå…ƒè–ªçº§"
                    },
                ].map((item) => new Station(item)),
                // å…¬ç›Š
                [PositionTypeEnum.WELFARE]: [
                    {
                        id: "1",
                        left: "40.3%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ¸…æ‰«è¡—é“ç¾åŒ–å¸‚å®¹',
                        description: "+2â™¥"
                    },
                    {
                        id: "2",
                        left: "40.3%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ¤æ ‘é€ æ—',
                        description: "+ğŸ²Ã—â™¥"
                    },
                    {
                        id: "3",
                        left: "40.3%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å€¡å¯¼ç¯ä¿',
                        description: "+ğŸ²Ã—ğŸ–"
                    },
                    {
                        id: "4",
                        left: "40.3%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ååŠ©åŒ»å¸ˆä¸‹ä¹¡ä¹‰è¯Š',
                        description: "+4ğŸ–"
                    },
                    {
                        id: "5",
                        left: "45%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'çƒ­å¿ƒè¿‡åº¦ä½“åŠ›ä¸æ”¯',
                        description: "é©¬ä¸Šç§»åˆ°åŒ»é™¢"
                    },
                    {
                        id: "6",
                        left: "49.8%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å»ºè®¾å†œæ‘ç”µåŠ›ç®¡çº¿',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "7",
                        left: "54.6%",
                        top: "30.9%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ææ¬¾åŠ©å­¦',
                        description: "+ğŸ²Ã—1000å…ƒ"
                    },
                    {
                        id: "8",
                        left: "54.6%",
                        top: "26.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'çˆ±å¿ƒæèµ å¼±åŠ¿ç¾¤ä½“',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "9",
                        left: "54.6%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é­é‡å¤©ç¾',
                        description: "é©¬ä¸Šç§»åˆ°å…¬å›­"
                    },
                    {
                        id: "10",
                        left: "49.8%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ·±å…¥ç¾åŒºæ•‘åŠ©éš¾æ°‘',
                        description: "+10â™¥"
                    },
                    {
                        id: "11",
                        left: "49.8%",
                        top: "16.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é€ æ¡¥é“ºè·¯',
                        description: "+3â™¥3ğŸ–"
                    },
                ].map((item) => new Station(item)),
                // ç”µå½±
                [PositionTypeEnum.MOVIES]: [
                    {
                        id: "1",
                        left: "64.2%",
                        top: "16.75%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‚åŠ è€ƒè¯•',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "2",
                        left: "64.2%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¹¿å‘Šå‡ºé“ä¸€é¸£æƒŠäºº',
                        description: "+4ğŸ–"
                    },
                    {
                        id: "3",
                        left: "64.2%",
                        top: "26.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è·å¾—ç”µå½±æ¼”å‡ºæœºä¼š',
                        description: "+ğŸ²Ã—1000å…ƒ"
                    },
                    {
                        id: "4",
                        left: "64.2%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç»¯é—»æ›å…‰',
                        description: "-â™¥/2"
                    },
                    {
                        id: "5",
                        left: "68.9%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç²‰ä¸æˆç«‹åæ´ä¼š',
                        description: "+3ğŸ–3â™¥"
                    },
                    {
                        id: "6",
                        left: "73.6%",
                        top: "31%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ä¸å®æŠ¥é“ä¸‘åŒ–å½¢è±¡',
                        description: "-ğŸ–/2"
                    },
                    {
                        id: "7",
                        left: "73.6%",
                        top: "26.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç”µå½±ä¸Šæ˜ å¤§å—æ¬¢è¿',
                        description: "åŠ ä¸€åƒå…ƒè–ªçº§"
                    },
                    {
                        id: "8",
                        left: "73.6%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆä¸ºæ‚å¿—å°é¢äººç‰©',
                        description: "+6000å…ƒ"
                    },
                    {
                        id: "9",
                        left: "78.4%",
                        top: "21.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è£è·é‡‘é©¬å¥–',
                        description: "+4ğŸ–4â™¥"
                    },
                ].map((item) => new Station(item)),
                // é‡‡çŸ¿
                [PositionTypeEnum.MINING]: [
                    {
                        id: "1",
                        left: "78.4%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'çŸ¿åŒºé‡‡æ ·',
                        description: "-2000å…ƒ"
                    },
                    {
                        id: "2",
                        left: "73.6%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘é“æ•´é¡¿',
                        description: "å†è¡ŒåŠ¨ä¸€æ¬¡"
                    },
                    {
                        id: "3",
                        left: "68.8%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å±±å´©',
                        description: "æš‚å®šä¸€æ¬¡"
                    },
                    {
                        id: "4",
                        left: "64.1%",
                        top: "40.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°é»„é‡‘',
                        description: "+2ğŸ–4â™¥"
                    },
                    {
                        id: "5",
                        left: "64.1%",
                        top: "45.3%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'åœ°è´¨åˆ†æ',
                        description: "-ğŸ²Ã—1000å…ƒ"
                    },
                    {
                        id: "6",
                        left: "64.1%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æ„å¤–å‘ç°æ–‡æ˜é—è¿¹',
                        description: "+10â™¥"
                    },
                    {
                        id: "7",
                        left: "64.1%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å¼•å‘å°˜æš´',
                        description: "é©¬ä¸Šç§»åˆ°åŒ»é™¢"
                    },
                    {
                        id: "8",
                        left: "68.8%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°çŸ³æ²¹',
                        description: "+8000å…ƒ"
                    },
                    {
                        id: "9",
                        left: "73.6%",
                        top: "54.7%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç ”å‘ç§˜å¯†è¾“é€ç®¡çº¿',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "10",
                        left: "73.6%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°é’»çŸ³',
                        description: "+6000å…ƒ"
                    },
                    {
                        id: "11",
                        left: "78.4%",
                        top: "50%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆç«‹è·¨å›½é‡‡çŸ¿é›†å›¢',
                        description: "+10000å…ƒ"
                    },
                ].map((item) => new Station(item)),
                // èˆªå¤©
                [PositionTypeEnum.SPACE]: [
                    {
                        id: "1",
                        left: "78.4%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ååŠ©å»ºé€ èˆªå¤©é£æœº',
                        description: "+6â™¥"
                    },
                    {
                        id: "2",
                        left: "73.6%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æˆåŠŸå‘å°„èˆªå¤©é£æœº',
                        description: "æŠ½ä¸¤å¼ ç»éªŒå¡"
                    },
                    {
                        id: "3",
                        left: "68.9%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‹åŠ›ä¸é€‚å¯¼è‡´å‘•å',
                        description: "-4ğŸ–"
                    },
                    {
                        id: "4",
                        left: "64.2%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é€šè®¯æ•…éšœ',
                        description: "-3000å…ƒ"
                    },
                    {
                        id: "5",
                        left: "59.5%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç´§æ€¥æŠ¢ä¿®',
                        description: "+2ğŸ–+4â™¥"
                    },
                    {
                        id: "6",
                        left: "54.7%",
                        top: "64.2%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'é—ªé¿é™¨çŸ³',
                        description: "+6ğŸ–"
                    },
                    {
                        id: "7",
                        left: "54.7%",
                        top: "69%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'ç™»é™†ç«æ˜Ÿ',
                        description: "+ğŸ²Ã—â™¥"
                    },
                    {
                        id: "8",
                        left: "54.7%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°ç«æ˜Ÿç‰¹æœ‰ç»†èŒ',
                        description: "+4000å…ƒ"
                    },
                    {
                        id: "9",
                        left: "59.5%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'æµ‹é‡åœ°å½¢',
                        description: "+10â™¥"
                    },
                    {
                        id: "10",
                        left: "64.2%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å‘ç°ç¥ç§˜æ–‡æ˜é—è¿¹',
                        description: "+10ğŸ–"
                    },
                    {
                        id: "11",
                        left: "68.9%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'èˆªå¤©æœç ´è£‚',
                        description: "é©¬ä¸Šç§»åŠ¨åŒ»é™¢"
                    },
                    {
                        id: "12",
                        left: "73.6%",
                        top: "73.8%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'è¿”èˆªåœ°çƒ',
                        description: "+6ğŸ–+4â™¥"
                    },
                    {
                        id: "13",
                        left: "73.6%",
                        top: "78.5%",
                        width: "4.7%",
                        height: "4.7%",
                        name: 'å°†ç»å†å†™æˆå°è¯´',
                        description: "+6000å…ƒ"
                    },
                ].map((item) => new Station(item)),
            }


            let scene = new SceneStation();


            for (const station of [...loopStations, ...Object.values(insideStations).flat()]) {
                let stationDom = createFragment(`<div class="station-item"></div>`).querySelector(".station-item")
                stationDom.style.left = station.left
                stationDom.style.top = station.top
                stationDom.style.width = station.width
                stationDom.style.height = station.height
                mapContainerDom.appendChild(stationDom)
                station.dom = stationDom
            }

            /**
             * ç©å®¶åŠ å…¥
             * @param {Player[]} players
             */
            let join = async (players) => {
                scene.allPlayers = players;
                for (const player of players) {
                    let playerItemTemplate = `
                        <div class="player-item" data-id="${player.id}">
                            <div class="player-avatar" style="background-image:url(${player.avatar});border-color:${player.color}"></div>
                        </div>
                    `
                    let playerFragment = createFragment(playerItemTemplate)
                    // èµ·ç‚¹å‡ºå‘
                    loopStations[0].dom.appendChild(playerFragment)
                }
            }
            /**
             * ç©å®¶ç§»åŠ¨
             * @param {Player} player
             * @param {number} count
             */
            let move = async (player, count) => {
                count = loopStations.length + 4
                scene.curPlayer = player;
                scene.dicePoints = count;

                let currDom = mapContainerDom.querySelector(`.player-item[data-id="${player.id}"]`);
                for (let i = 0; i < count; i++) {
                    // await wait(500); // æµ‹è¯•åŠ é€Ÿ
                    player.position++
                    player.save() // æš‚å­˜ä½ç½®ä¿¡æ¯
                    let station = loopStations[player.position % loopStations.length];
                    station.dom.appendChild(currDom)
                    if (count - i > 1) await station.viaâ€Œ?.(scene) // ç»è¿‡
                    else await station.stop?.(scene)  // åœç•™
                    lookAt(currDom.parentNode) // é•œå¤´è·Ÿéš
                }

            }

            /**
             * ä¸‹ä¸€ä¸ªç©å®¶
             * @param {Player} player 
             */
            let next = async (player) => {
                let lastDom = mapContainerDom.querySelector('.player-item.active');
                let currDom = mapContainerDom.querySelector(`.player-item[data-id="${player.id}"]`);
                if (lastDom) lastDom.classList.remove('active')
                currDom.classList.add('active')
                lookAt(currDom.parentNode) // é•œå¤´è·Ÿéš
            }

            return {
                fragment,
                join,
                move,
                next
            }
        }()


        /**
         * åˆå§‹åŒ–æ¸¸æˆå†…å®¹
         * @author 	 linyisonger
         * @date 	 2024-11-29
         */
        async function initGame() {
            let gameContainerDom = createFragment(`<div class="game-container"></div>`).querySelector('.game-container')
            // gameContainerDom.appendChild(mapContainer.fragment)
            gameContainerDom.appendChild(logContainer.fragment)
            gameContainerDom.appendChild(dialogContainer.fragment)
            // gameContainerDom.appendChild(diceContainer.fragment)
            // gameContainerDom.appendChild(roleContainer.fragment)
            // gameContainerDom.appendChild(playerContainer.fragment)
            document.body.appendChild(gameContainerDom)

            // æ·éª°å­
            // diceContainer.open(1, (total) => {
            //     // æ‰§è¡Œäº‹ä»¶
            //     logContainer.log(`XXX æ·å¾— ${total} ç‚¹`)
            //     // 
            // }) 
            // 

            // é€‰æ‹©è§’è‰²
            // roleContainer.open((roles) => {
            //     console.log(roles);
            // })

            // é€‰ä¸­çš„è§’è‰²
            let roles = [
                {
                    "name": "å°é»‘",
                    "avatar": "./assets/monopoly/black.jpg",
                    "color": "black",
                    "targetRiches": 60,
                    "targetRepute": 0,
                    "targetHapply": 0
                },
                {
                    "name": "å°çº¢",
                    "avatar": "./assets/monopoly/red.jpg",
                    "color": "red",
                    "targetRiches": 60,
                    "targetRepute": 0,
                    "targetHapply": 0
                }
            ]

            // é˜Ÿåˆ—
            const queue = {
                players: [], // ç©å®¶åˆ—è¡¨
                join: function (players) {
                    this.players = players;
                    playerContainer.join(players)
                    mapContainer.join(players)
                    return this;
                },
                next: function () {
                    let player = this.players.shift()
                    mapContainer.next(player)
                    playerContainer.next(player)
                    logContainer.log(`ç©å®¶[${player.name}]å¼€å§‹æ·éª°å­ğŸ²`)

                    diceContainer.open(2, async (total) => {
                        logContainer.log(`ç©å®¶[${player.name}]æŠ•æ·æ•°ä¸º[${total}]`)
                        diceContainer.close()
                        await mapContainer.move(player, total)
                        this.players.push(player);
                        this.next()
                    })
                },
            }

            // queue.join(roles.map(r => new Player(r))).next()


            let selected = await dialogContainer.open({
                title: 'æç¤º',
                content: 'è¯·é€‰æ‹©æƒ³è¦çš„é€‰é¡¹',
                options: ["A", "B", "C"]
            })
            console.log(selected);


        }

        initGame();

    </script>
</body>

</html>