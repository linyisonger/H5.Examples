<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/global.css">

    <style>
        .snake-map {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .snake-map .snake-item {
            background-color: saddlebrown;
            position: absolute;
            width: 20px;
            height: 20px;
        }

        .snake-map .snake-item.snake {
            background-color: green;
        }

        .snake-map .snake-item.apple {
            background-color: crimson;
        }

        .operate {
            display: flex;
            flex-wrap: wrap;
            margin: 0 20px;
            width: 120px;
            padding: 20px 0;
        }

        .operate .btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .operate .btn:active {
            background-color: saddlebrown;
            color: #fff;
            transition: all .4s ease-in-out;
        }

        .operate .flex {
            width: 100%;
        }

        .desc {
            margin: 20px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body>
    <div class="snake-map"> </div>

    <div class="desc">ç©æ³•ï¼šé€šè¿‡ä¸Šä¸‹å·¦å³é”®æˆ–å±å¹•ä¸Šçš„ä¸Šä¸‹å·¦å³å°†ä½¿å…¶ç»¿è‰²çº¿æ¡ï¼ˆğŸï¼‰åƒåˆ°çº¢è‰²æ–¹å—ï¼ˆğŸï¼‰è®°å½•å¾—åˆ†ã€‚</div>
    <div class="operate">
        <div class="btn flex">ä¸Š</div>
        <div class="btn">å·¦</div>
        <div class="btn">ä¸‹</div>
        <div class="btn">å³</div>
    </div>
    <script type="module">
        import { v2, Maths, Randoms, cloneDeep } from "https://unpkg.com/@3r/tool";

        let width = 20, height = 20;

        let map = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ]

        let mapEnum = {
            blank: 0, // ç©ºç™½æ ¼
            snake: 1, // è›‡ ğŸ
            apple: 2, // è‹¹æœ ğŸ
        }
        // è›‡æ•°æ®
        let snake = [v2(5, 5), v2(5, 6)]
        // ç§»åŠ¨æ–¹å‘
        let movingDirection = v2(1, 0)
        // å®¹å™¨
        let snakeConDom = document.querySelector('.snake-map')
        // æ“ä½œå…ƒç´ 
        let operateDom = document.querySelectorAll('.operate > .btn')
        // åœ°å›¾
        let snakeMapDom = {}

        // åœ°å›¾æœ€å¤§è¾¹ç•Œ
        let maxY = 0;
        let maxX = 0;

        // å»¶è¿Ÿ
        let intervalTime = 500;
        let intervalId = 0;

        // åˆå§‹åŒ–
        function init() {
            let ylength = map.length, xlength = 0;
            for (let y = 0; y < map.length; y++) {
                const xmap = map[y];
                xlength = Math.max(xlength, xmap.length)
                for (let x = 0; x < xmap.length; x++) {
                    let snakeItem = document.createElement('div')
                    snakeItem.classList.add('snake-item')
                    snakeItem.setAttribute(`style`, `left:${x * width}px;top:${y * height}px`)
                    snakeConDom.appendChild(snakeItem)
                    snakeMapDom[`${x},${y}`] = snakeItem
                }
            }

            for (let i = 0; i < snake.length; i++) {
                const snakeBody = snake[i];
                map[snakeBody.y][snakeBody.x] = mapEnum.snake;
            }
            snakeConDom.setAttribute(`style`, `width:${xlength * width}px;height:${ylength * height}px`)

            for (let i = 0; i < operateDom.length; i++) {
                const btn = operateDom.item(i);
                btn.addEventListener('click', function () {
                    onKeyDown(['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'][i])
                })
            }

            maxY = ylength;
            maxX = xlength;

            generateApple();
        }
        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            for (let y = 0; y < map.length; y++) {
                const xmap = map[y];
                for (let x = 0; x < xmap.length; x++) {
                    let snakeItem = snakeMapDom[`${x},${y}`]
                    if (xmap[x] == mapEnum.snake) snakeItem.classList.add('snake')
                    else snakeItem.classList.remove('snake')
                    if (xmap[x] == mapEnum.apple) snakeItem.classList.add('apple')
                    else snakeItem.classList.remove('apple')
                }
            }
        }
        // ç”Ÿæˆè‹¹æœ
        function generateApple() {
            let apple = v2(Randoms.getRandomInt(0, maxX), Randoms.getRandomInt(0, maxY))
            if (map[apple.y][apple.x] != mapEnum.blank) return generateApple();
            map[apple.y][apple.x] = mapEnum.apple;
            return;
        }
        // ç§»åŠ¨
        function moving() {
            // è¿åŠ¨ä¸º0æ—¶åˆ™åœæ­¢è¿åŠ¨
            if (Maths.equal(movingDirection, v2(0, 0))) return;
            // å¤´
            let head = cloneDeep(snake[0])
            // æ–°å¤´
            let newHead = head.plus(movingDirection)
            // å½“æ–°å¤´éƒ¨æ˜¯ç©ºç™½æ—¶
            if (map?.[newHead.y]?.[newHead.x] == mapEnum.blank) {
                // å°¾å·´
                let tail = snake.pop()
                map[tail.y][tail.x] = mapEnum.blank;
                map[newHead.y][newHead.x] = mapEnum.snake;
                snake.unshift(newHead)
            }
            // å†ç”Ÿæˆä¸€ä¸ªæ–°ğŸ
            else if (map?.[newHead.y]?.[newHead.x] == mapEnum.apple) {
                generateApple()
                map[newHead.y][newHead.x] = mapEnum.snake;
                snake.unshift(newHead)
            }
            else {
                clearInterval(intervalId)
                snakeConDom.innerHTML = `æ¸¸æˆç»“æŸï¼Œå¾—åˆ†ä¸º${snake.length - 2}`
            }
            renderMap()
        }

        function onKeyDown(key) {
            let direction = v2(0, 0)
            if (key == 'ArrowUp') direction = v2(0, -1)
            if (key == 'ArrowDown') direction = v2(0, 1)
            if (key == 'ArrowLeft') direction = v2(-1, 0)
            if (key == 'ArrowRight') direction = v2(1, 0)

            // å¦‚æœæ²¡æœ‰è¿åŠ¨æ–¹å‘
            if (Maths.equal(movingDirection, direction)) return;
            let cannotMovingDirection = snake[1].subtract(snake[0]);
            // å¦‚æœç§»åŠ¨æ–¹å‘æ˜¯ç¦æ­¢çš„
            if (Maths.equal(cannotMovingDirection, direction)) return;
            movingDirection = direction;
        }

        document.addEventListener("keydown", (ev) => onKeyDown(ev.key))

        init();
        renderMap()

        intervalId = setInterval(moving, intervalTime)

    </script>
</body>

</html>